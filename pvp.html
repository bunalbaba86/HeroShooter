<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Turn-Based PvP Game</title>
<style>
  /* Temel stil */
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    max-width: 900px;
    margin: 0 auto;
    padding: 10px;
  }
  .player, .enemy {
    border: 1px solid #ccc;
    padding: 15px;
    margin: 10px auto;
    width: 300px;
    position: relative;
  }
  .health-bar, .mana-bar {
    height: 20px;
    background-color: #eee;
    border-radius: 10px;
    margin: 5px 0;
    overflow: hidden;
  }
  .health-bar > div, .mana-bar > div {
    height: 100%;
    transition: width 0.3s ease;
  }
  .health-bar > div {
    background-color: #e74c3c;
  }
  .mana-bar > div {
    background-color: #3498db;
  }
  button {
    margin: 5px;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
    pointer-events: none;
  }
  #status {
    font-weight: bold;
    margin: 15px 0;
    min-height: 24px;
  }
  #chat {
    border: 1px solid #ddd;
    height: 150px;
    overflow-y: auto;
    margin: 15px 0;
    padding: 10px;
    text-align: left;
    background: #fafafa;
  }
  #chat input[type=text] {
    width: 80%;
    padding: 8px;
    font-size: 14px;
  }
  #chat button {
    width: 18%;
  }
  .floating-damage {
    position: absolute;
    font-weight: bold;
    color: red;
    animation: floatUp 1s ease forwards;
    pointer-events: none;
    user-select: none;
  }
  @keyframes floatUp {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-40px);
    }
  }
  .shake {
    animation: shakeAnim 0.3s ease;
  }
  @keyframes shakeAnim {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Responsive basit örnek */
  @media (max-width: 500px) {
    .player, .enemy {
      width: 90%;
    }
    button {
      font-size: 14px;
      padding: 8px 10px;
    }
  }
</style>
</head>
<body>

<div id="your-player" class="player">
  <h2>You</h2>
  <div>Health: <span id="your-health-text">100</span>/<span id="your-max-health-text">100</span></div>
  <div class="health-bar"><div id="your-health-bar" style="width: 100%;"></div></div>
  <div>Mana: <span id="your-mana-text">50</span>/50</div>
  <div class="mana-bar"><div id="your-mana-bar" style="width: 100%;"></div></div>
  <div id="your-damage-container" style="position:relative; height: 40px;"></div>
  <button id="attack-btn">Attack</button>
  <button id="defend-btn">Defend</button>
  <button id="mana-btn">Use Mana</button>
</div>

<div id="enemy-player" class="enemy">
  <h2>Enemy</h2>
  <div>Health: <span id="enemy-health-text">100</span>/100</div>
  <div class="health-bar"><div id="enemy-health-bar" style="width: 100%;"></div></div>
  <div>Mana: <span id="enemy-mana-text">50</span>/50</div>
  <div class="mana-bar"><div id="enemy-mana-bar" style="width: 100%;"></div></div>
  <div id="enemy-damage-container" style="position:relative; height: 40px;"></div>
</div>

<div id="status"></div>
<button id="backToMenuBtn" style="display:none;">Back to Menu</button>

<div id="chat">
  <div id="chat-messages"></div>
  <input id="chat-input" type="text" placeholder="Type message..." autocomplete="off" />
  <button id="chat-send-btn">Send</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(() => {
  const MAX_HEALTH = 100;
  const MAX_MANA = 50;

  // Elements
  const yourHealthBar = document.getElementById("your-health-bar");
  const yourHealthText = document.getElementById("your-health-text");
  const yourMaxHealthText = document.getElementById("your-max-health-text");
  const yourManaBar = document.getElementById("your-mana-bar");
  const yourManaText = document.getElementById("your-mana-text");
  const enemyHealthBar = document.getElementById("enemy-health-bar");
  const enemyHealthText = document.getElementById("enemy-health-text");
  const enemyManaBar = document.getElementById("enemy-mana-bar");
  const enemyManaText = document.getElementById("enemy-mana-text");

  const attackBtn = document.getElementById("attack-btn");
  const defendBtn = document.getElementById("defend-btn");
  const manaBtn = document.getElementById("mana-btn");
  const backToMenuBtn = document.getElementById("backToMenuBtn");
  const statusEl = document.getElementById("status");

  const yourDamageContainer = document.getElementById("your-damage-container");
  const enemyDamageContainer = document.getElementById("enemy-damage-container");

  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const chatSendBtn = document.getElementById("chat-send-btn");

  let victorySound;
  let canPlayVictorySound = false;

  // Socket setup
  const socket = io();

  // Initialize health/mana text max values
  yourMaxHealthText.textContent = MAX_HEALTH;

  // Enable victory sound only after user interaction (browser autoplay policy)
  function initVictorySound() {
    victorySound = new Audio('/victory.mp3');
    canPlayVictorySound = true;
  }
  window.addEventListener('click', initVictorySound, { once: true });
  window.addEventListener('keydown', initVictorySound, { once: true });

  function updatePlayerData(yourData, enemyData) {
    // Health & Mana update (clamp between 0 and max)
    const yourHealthPercent = Math.max(0, Math.min(yourData.health, MAX_HEALTH)) / MAX_HEALTH * 100;
    const yourManaPercent = Math.max(0, Math.min(yourData.mana, MAX_MANA)) / MAX_MANA * 100;
    const enemyHealthPercent = Math.max(0, Math.min(enemyData.health, MAX_HEALTH)) / MAX_HEALTH * 100;
    const enemyManaPercent = Math.max(0, Math.min(enemyData.mana, MAX_MANA)) / MAX_MANA * 100;

    yourHealthBar.style.width = yourHealthPercent + "%";
    yourManaBar.style.width = yourManaPercent + "%";
    enemyHealthBar.style.width = enemyHealthPercent + "%";
    enemyManaBar.style.width = enemyManaPercent + "%";

    yourHealthText.textContent = yourData.health;
    yourManaText.textContent = yourData.mana;
    enemyHealthText.textContent = enemyData.health;
    enemyManaText.textContent = enemyData.mana;
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function enableButtons(enabled) {
    attackBtn.disabled = !enabled;
    defendBtn.disabled = !enabled;
    manaBtn.disabled = !enabled;
  }

  // Show floating damage text on target container
  function showDamage(container, text) {
    const dmgEl = document.createElement("div");
    dmgEl.className = "floating-damage";
    dmgEl.textContent = text;
    container.appendChild(dmgEl);
    // Random horizontal offset for variety
    dmgEl.style.left = (Math.random() * 60 + 10) + "px";
    // Animation removal after done
    dmgEl.addEventListener("animationend", () => {
      dmgEl.remove();
    });
  }

  // Shake animation on element
  function shakeElement(element) {
    element.classList.add("shake");
    element.addEventListener("animationend", () => {
      element.classList.remove("shake");
    }, { once: true });
  }

  // Buttons click handlers
  function sendMove(move) {
    enableButtons(false);
    socket.emit("makeMove", move);
  }

  attackBtn.addEventListener("click", () => sendMove("attack"));
  defendBtn.addEventListener("click", () => sendMove("defend"));
  manaBtn.addEventListener("click", () => sendMove("mana"));

  backToMenuBtn.addEventListener("click", () => {
    // sayfa yenilemek veya menüye gitmek için
    window.location.reload();
  });

  // Chat send
  function sendChatMessage() {
    const msg = chatInput.value.trim();
    if (msg.length === 0) return;
    socket.emit("chatMessage", msg);
    chatInput.value = "";
  }
  chatSendBtn.addEventListener("click", sendChatMessage);
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      sendChatMessage();
    }
  });

  // Socket events
  socket.on("connect", () => {
    setStatus("Connected. Waiting for opponent...");
    enableButtons(false);
  });

  socket.on("gameStart", () => {
    setStatus("Game started! Your turn.");
    enableButtons(true);
  });

  socket.on("yourTurn", () => {
    setStatus("Your turn. Choose your move.");
    enableButtons(true);
  });

  socket.on("opponentTurn", () => {
    setStatus("Opponent's turn. Please wait.");
    enableButtons(false);
  });

  socket.on("moveResult", (data) => {
    // data example: {yourData: {...}, enemyData: {...}, move: "attack", damageToEnemy: 20, damageToYou: 10}
    updatePlayerData(data.yourData, data.enemyData);

    // Damage animations & shakes
    if (data.damageToEnemy) {
      showDamage(enemyDamageContainer, "-" + data.damageToEnemy);
      shakeElement(document.getElementById("enemy-player"));
    }
    if (data.damageToYou) {
      showDamage(yourDamageContainer, "-" + data.damageToYou);
      shakeElement(document.getElementById("your-player"));
    }
  });

  socket.on("gameOver", (data) => {
    // data example: {winner: "you"/"enemy"/"draw", message: "..."}
    setStatus(data.message);
    enableButtons(false);
    backToMenuBtn.style.display = "inline-block";
    if (data.winner === "you" && canPlayVictorySound) {
      victorySound.play().catch(() => { /* ignore errors */ });
    }
  });

  socket.on("errorMessage", (msg) => {
    setStatus("Error: " + msg);
  });

  socket.on("chatMessage", (msg) => {
    const p = document.createElement("p");
    p.textContent = msg; // Güvenlik için textContent kullanıyoruz
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  socket.on("waitingForOpponent", () => {
    setStatus("Waiting for opponent...");
    enableButtons(false);
  });

})();
</script>

</body>
</html>
