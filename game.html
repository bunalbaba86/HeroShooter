<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFT PvP Turn-Based Game + Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    display: flex;
    width: 900px;
    max-width: 100vw;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
  }
  #game {
    flex: 2;
    padding: 20px;
    position: relative;
  }
  
  /* MetaMask Connection Styles */
  #metamask-container, #nft-selection-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  #metamask-modal, #nft-selection-modal {
    background: #333;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  #connect-wallet-btn {
    background: #f6851b;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: background 0.3s;
  }
  
  #connect-wallet-btn:hover {
    background: #e2761b;
  }
  
  #connect-wallet-btn:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  /* NFT Selection Styles */
  #nft-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  
  .nft-card {
    background: #444;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .nft-card:hover {
    transform: scale(1.05);
    border-color: #3498db;
  }
  
  .nft-card.selected {
    border-color: #2ecc71;
    background: #2d5a2d;
  }
  
  .nft-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 5px;
    margin-bottom: 10px;
  }
  
  .nft-info {
    font-size: 12px;
  }
  
  .nft-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 10px;
  }
  
  .stat {
    background: #555;
    padding: 2px 5px;
    border-radius: 3px;
    margin: 1px;
  }
  
  .health-stat { background: #e74c3c; }
  .attack-stat { background: #f39c12; }
  .defense-stat { background: #3498db; }
  .speed-stat { background: #9b59b6; }
  
  #select-nft-btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: background 0.3s;
  }
  
  #select-nft-btn:hover {
    background: #27ae60;
  }
  
  #select-nft-btn:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  .wallet-status {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #444;
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 12px;
    color: #4CAF50;
  }
  
  .player-area {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
  }
  .player {
    width: 45%;
    background: #444;
    border-radius: 8px;
    padding: 10px;
    position: relative;
  }
  
  /* Player NFT info display */
  .player-nft-info {
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 10px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    word-break: break-all;
  }
  
  .player-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
    font-size: 10px;
  }
  
  .your-nft-info {
    color: #3498db;
  }
  
  .enemy-nft-info {
    color: #e74c3c;
  }
  
  .player img.character {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #666;
    margin-bottom: 10px;
    object-fit: cover;
  }
  .bar {
    background: #555;
    border-radius: 5px;
    height: 20px;
    margin-bottom: 10px;
    position: relative;
  }
  .bar-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s ease;
  }
  .health-fill {
    background: #e74c3c;
  }
  .mana-fill {
    background: #3498db;
  }
  .bar-label {
    position: absolute;
    width: 100%;
    text-align: center;
    font-weight: bold;
    top: 0;
    color: #fff;
  }
  #actions {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
  }
  button.action-btn {
    background: #555;
    border: none;
    border-radius: 8px;
    width: 80px;
    height: 80px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    position: relative;
  }
  button.action-btn:disabled {
    background: #222;
    cursor: not-allowed;
    opacity: 0.5;
  }
  button.action-btn img {
    width: 40px;
    height: 40px;
    margin-bottom: 5px;
  }
  #status {
    margin-top: 20px;
    font-size: 18px;
    height: 24px;
  }
  #victory-message {
    font-size: 36px;
    font-weight: bold;
    color: #2ecc71;
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    padding: 20px 40px;
    border-radius: 12px;
    display: none;
    z-index: 10;
  }
  #back-to-menu-btn, #play-again-btn {
    display: none;
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    background: #3498db;
    border: none;
    color: white;
    border-radius: 4px;
    position: absolute;
    z-index: 11;
  }
  #back-to-menu-btn {
    top: 55%;
    left: 35%;
    transform: translate(-50%, -50%);
  }
  #play-again-btn {
    top: 55%;
    left: 65%;
    transform: translate(-50%, -50%);
  }

  /* CHAT STYLES */
  #chat-container {
    flex: 1;
    background: #222;
    display: flex;
    flex-direction: column;
    border-left: 2px solid #444;
  }
  #chat-messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.3;
    color: #ddd;
  }
  #chat-input-area {
    display: flex;
    padding: 10px;
    background: #111;
    position: relative;
  }
  #chat-input {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
  }
  #chat-send-btn {
    background: #3498db;
    border: none;
    color: white;
    font-weight: bold;
    padding: 8px 12px;
    margin-left: 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  #chat-send-btn:disabled {
    background: #555;
    cursor: not-allowed;
  }
  .chat-message {
    margin-bottom: 8px;
    word-break: break-word;
  }
  .chat-message.you {
    color: #76c7f0;
  }
  .chat-message.enemy {
    color: #e67e22;
  }
  .chat-message.system {
    color: #95a5a6;
    font-style: italic;
  }
  
  /* Animation styles */
  @keyframes damageEffect {
    0% { transform: scale(1); opacity: 1; }
    25% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
  }
  @keyframes healEffect {
    0% { transform: scale(1); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
  }
  @keyframes hydraEffect {
    0% { filter: drop-shadow(0 0 5px rgba(0, 255, 0, 0)); }
    50% { filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.8)); }
    100% { filter: drop-shadow(0 0 5px rgba(0, 255, 0, 0)); }
  }
  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }
  .damage-number {
    animation: damageEffect 0.8s ease-out forwards;
    position: absolute;
    font-weight: bold;
    font-size: 24px;
    color: #ff4d4d;
    pointer-events: none;
    z-index: 100;
  }
  .heal-number {
    animation: healEffect 0.8s ease-out forwards;
    position: absolute;
    font-weight: bold;
    font-size: 24px;
    color: #4dff4d;
    pointer-events: none;
    z-index: 100;
  }
  .mana-number {
    animation: healEffect 0.8s ease-out forwards;
    position: absolute;
    font-weight: bold;
    font-size: 24px;
    color: #4d4dff;
    pointer-events: none;
    z-index: 100;
  }
  .shake-animation {
    animation: shake 0.5s ease-in-out;
  }
  .hydra-active {
    animation: hydraEffect 2s infinite;
  }
  
  /* Karakter sayısı göstergesi */
  #char-count {
    font-size: 12px;
    color: #aaa;
    position: absolute;
    right: 60px;
    bottom: 10px;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
  }
  
  .spinner {
    border: 3px solid #444;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<!-- MetaMask Connection Modal -->
<div id="metamask-container">
  <div id="metamask-modal">
    <h2>Connect Your Wallet</h2>
    <p>You need to connect your MetaMask wallet to play this game.</p>
    <div id="metamask-status">
      <p id="connection-status">Please install MetaMask or connect your wallet.</p>
    </div>
    <button id="connect-wallet-btn">Connect MetaMask</button>
  </div>
</div>

<!-- NFT Selection Modal -->
<div id="nft-selection-container" style="display: none;">
  <div id="nft-selection-modal">
    <h2>Select Your NFT Character</h2>
    <p>Choose an NFT from your collection to use as your character:</p>
    <div id="nft-loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <span style="margin-left: 10px;">Loading your NFTs...</span>
    </div>
    <div id="nft-grid"></div>
    <button id="select-nft-btn" disabled>Select Character</button>
  </div>
</div>

<!-- Wallet Status Display -->
<div class="wallet-status" id="wallet-status" style="display: none;">
  Connected: <span id="connected-address"></span>
</div>

<div id="container" style="display: none;">
  <div id="game">
    <div class="player-area">
      <div class="player" id="you">
        <div class="player-nft-info your-nft-info" id="your-nft-info">Your NFT</div>
        <div class="player-stats" id="your-stats">
          <span class="stat health-stat">HP: <span id="your-base-health">100</span></span>
          <span class="stat attack-stat">ATK: <span id="your-attack">10</span></span>
          <span class="stat defense-stat">DEF: <span id="your-defense">5</span></span>
        </div>
        <img src="" alt="Your NFT" class="character" id="player-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="you-health" style="width: 100%;"></div>
          <div class="bar-label" id="you-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="you-mana" style="width: 100%;"></div>
          <div class="bar-label" id="you-mana-label">Mana: 0</div>
        </div>
        <div id="player-damage-display" class="damage-display"></div>
      </div>

      <div class="player" id="enemy">
        <div class="player-nft-info enemy-nft-info" id="enemy-nft-info">Enemy NFT</div>
        <div class="player-stats" id="enemy-stats">
          <span class="stat health-stat">HP: <span id="enemy-base-health">100</span></span>
          <span class="stat attack-stat">ATK: <span id="enemy-attack">10</span></span>
          <span class="stat defense-stat">DEF: <span id="enemy-defense">5</span></span>
        </div>
        <img src="" alt="Enemy NFT" class="character" id="enemy-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="enemy-health" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="enemy-mana" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-mana-label">Mana: 0</div>
        </div>
        <div id="enemy-damage-display" class="damage-display"></div>
      </div>
    </div>

    <div id="actions">
      <button class="action-btn" id="attack-btn" title="Attack">
        <img src="attack.png" alt="Attack" /><br />
        Attack
      </button>
      <button class="action-btn" id="defend-btn" title="Defend">
        <img src="defend.png" alt="Defend" /><br />
        Defend
      </button>
      <button class="action-btn" id="skill-btn" title="Special Skill">
        <img src="skill.png" alt="Skill" /><br />
        Skill
      </button>
      <button class="action-btn" id="mana-btn" title="Restore Mana">
        <img src="mana.png" alt="Mana" /><br />
        Mana
      </button>
      <button class="action-btn" id="hydra-btn" title="Ultimate Attack">
        <img src="hydra.png" alt="Hydra" /><br />
        Ultimate
      </button>
    </div>

    <div id="status"></div>

    <div id="victory-message">Victory!</div>
    <button id="back-to-menu-btn">Back To Menu</button>
    <button id="play-again-btn">Play Again</button>
    <audio id="victory-sound" src="victory.mp3" preload="auto"></audio>
  </div>

  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Write message... (max 20 chars)" autocomplete="off" maxlength="20" />
      <span id="char-count">0/20</span>
      <button id="chat-send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<script>
  // MetaMask ve Web3 değişkenleri
  let currentAccount = null;
  let provider = null;
  let selectedNFT = null;
  let userNFTs = [];

  // NFT Contract Address
  const NFT_CONTRACT_ADDRESS = "0xdfdb045e4300d04ec32058756ec2453409360c5b";

  // DOM elemanları
  const metamaskContainer = document.getElementById('metamask-container');
  const nftSelectionContainer = document.getElementById('nft-selection-container');
  const connectWalletBtn = document.getElementById('connect-wallet-btn');
  const connectionStatus = document.getElementById('connection-status');
  const walletStatus = document.getElementById('wallet-status');
  const connectedAddress = document.getElementById('connected-address');
  const gameContainer = document.getElementById('container');
  const nftGrid = document.getElementById('nft-grid');
  const selectNFTBtn = document.getElementById('select-nft-btn');
  const nftLoading = document.getElementById('nft-loading');

  // NFT özelliklerinden oyun statları hesaplama
  function calculateNFTStats(nft) {
    // NFT metadata'sından özellikler çıkarma
    let health = 150; // Base health
    let attack = 15;  // Base attack
    let defense = 5;  // Base defense
    let speed = 10;   // Base speed

    // NFT attributes varsa bunları kullan
    if (nft.traits) {
      nft.traits.forEach(trait => {
        const value = parseInt(trait.value) || 0;
        
        switch (trait.trait_type?.toLowerCase()) {
          case 'strength':
          case 'attack':
          case 'power':
            attack += Math.floor(value / 10);
            break;
          case 'health':
          case 'vitality':
          case 'hp':
            health += value * 2;
            break;
          case 'defense':
          case 'armor':
          case 'shield':
            defense += Math.floor(value / 15);
            break;
          case 'speed':
          case 'agility':
          case 'dexterity':
            speed += Math.floor(value / 12);
            break;
          case 'rarity':
            // Rarity'e göre tüm statları artır
            if (trait.value === 'Legendary') {
              health += 50;
              attack += 10;
              defense += 5;
            } else if (trait.value === 'Epic') {
              health += 30;
              attack += 6;
              defense += 3;
            } else if (trait.value === 'Rare') {
              health += 20;
              attack += 4;
              defense += 2;
            }
            break;
        }
      });
    }

    // Token ID'den de özellik çıkar (hash bazlı)
    const tokenIdNum = parseInt(nft.tokenId) || 0;
    const hashValue = tokenIdNum % 100;
    
    if (hashValue > 90) {
      // %10 şans ile legendary bonus
      health += 40;
      attack += 8;
      defense += 4;
    } else if (hashValue > 70) {
      // %20 şans ile epic bonus
      health += 25;
      attack += 5;
      defense += 2;
    } else if (hashValue > 40) {
      // %30 şans ile rare bonus
      health += 15;
      attack += 3;
      defense += 1;
    }

    return {
      health: Math.min(health, 300), // Max 300 health
      attack: Math.min(attack, 40),  // Max 40 attack
      defense: Math.min(defense, 20), // Max 20 defense
      speed: Math.min(speed, 30)     // Max 30 speed
    };
  }

  // MetaMask kontrolü
  async function checkMetaMask() {
    if (typeof window.ethereum !== 'undefined') {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      connectWalletBtn.textContent = 'Connect MetaMask';
      connectWalletBtn.disabled = false;
      
      // Önceden bağlı hesapları kontrol et
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        showNFTSelection();
      }
    } else {
      connectionStatus.textContent = 'MetaMask is not installed. Please install MetaMask to continue.';
      connectWalletBtn.textContent = 'Install MetaMask';
      connectWalletBtn.onclick = () => {
        window.open('https://metamask.io/', '_blank');
      };
    }
  }

  // MetaMask'a bağlanma fonksiyonu
  async function connectWallet() {
    try {
      connectWalletBtn.disabled = true;
      connectWalletBtn.textContent = 'Connecting...';
      
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts',
      });
      
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        showNFTSelection();
      }
    } catch (error) {
      console.error('Wallet connection failed:', error);
      connectionStatus.textContent = 'Connection failed. Please try again.';
      connectWalletBtn.disabled = false;
      connectWalletBtn.textContent = 'Connect MetaMask';
    }
  }

  // NFT seçim ekranını göster
  async function showNFTSelection() {
    metamaskContainer.style.display = 'none';
    nftSelectionContainer.style.display = 'flex';
    
    // Adresi göster
    const shortAddress = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
    connectedAddress.textContent = shortAddress;
    walletStatus.style.display = 'block';
    
    // NFT'leri yükle
    await loadUserNFTs();
  }

  // Kullanıcının NFT'lerini yükle
  async function loadUserNFTs() {
    try {
      nftLoading.style.display = 'flex';
      nftGrid.innerHTML = '';
      
      // OpenSea API ile NFT'leri al
      const response = await fetch(`https://api.opensea.io/api/v1/assets?owner=${currentAccount}&asset_contract_address=${NFT_CONTRACT_ADDRESS}&limit=20`);
      const data = await response.json();
      
      if (data.assets && data.assets.length > 0) {
        userNFTs = data.assets.map(asset => ({
          tokenId: asset.token_id,
          name: asset.name || `#${asset.token_id}`,
          image: asset.image_url || asset.image_original_url,
          traits: asset.traits || [],
          description: asset.description
        }));
        
        displayNFTs();
      } else {
        // Eğer OpenSea'den veri gelmezse, Alchemy API'yi dene
        await loadNFTsFromAlchemy();
      }
    } catch (error) {
      console.error('Error loading NFTs:', error);
      // Fallback: Demo NFT'ler göster
      createDemoNFTs();
    } finally {
      nftLoading.style.display = 'none';
    }
  }

  // Alchemy API ile NFT yükleme (backup)
  async function loadNFTsFromAlchemy() {
    try {
      // Alchemy API key gerektirir, demo için bypass
      console.log('Trying Alchemy API...');
      createDemoNFTs();
    } catch (error) {
      console.error('Alchemy API error:', error);
      createDemoNFTs();
    }
  }

  // Demo NFT'ler oluştur (API'ler çalışmazsa)
  function createDemoNFTs() {
    userNFTs = [
      {
        tokenId: "1",
        name: "Warrior #1",
        image: "https://via.placeholder.com/150?text=Warrior",
        traits: [
          { trait_type: "Strength", value: "85" },
          { trait_type: "Health", value: "12" },
          { trait_type: "Rarity", value: "Epic" }
        ]
      },
      {
        tokenId: "2", 
        name: "Mage #2",
        image: "https://via.placeholder.com/150?text=Mage",
        traits: [
          { trait_type: "Attack", value: "95" },
          { trait_type: "Defense", value: "45" },
          { trait_type: "Rarity", value: "Legendary" }
        ]
      },
      {
        tokenId: "3",
        name: "Archer #3", 
        image: "https://via.placeholder.com/150?text=Archer",
        traits: [
          { trait_type: "Speed", value: "88" },
          { trait_type: "Power", value: "67" },
          { trait_type: "Rarity", value: "Rare" }
        ]
      }
    ];
    
    displayNFTs();
  }

  // NFT'leri ekranda göster
  function displayNFTs() {
    nftGrid.innerHTML = '';
    
    userNFTs.forEach((nft, index) => {
      const stats = calculateNFTStats(nft);
      
      const nftCard = document.createElement('div');
      nftCard.className = 'nft-card';
      nftCard.dataset.index = index;
      
      nftCard.innerHTML = `
        <img src="${nft.image}" alt="${nft.name}" class="nft-image" />
        <div class="nft-info">
          <div style="font-weight: bold; margin-bottom: 5px;">${nft.name}</div>
          <div class="nft-stats">
            <span class="stat health-stat">HP: ${stats.health}</span>
            <span class="stat attack-stat">ATK: ${stats.attack}</span>
          </div>
          <div class="nft-stats">
            <span class="stat defense-stat">DEF: ${stats.defense}</span>
            <span class="stat speed-stat">SPD: ${stats.speed}</span>
          </div>
        </div>
      `;
      
      nftCard.addEventListener('click', () => selectNFTCard(index));
      nftGrid.appendChild(nftCard);
    });
  }

  // NFT kartı seçimi
  function selectNFTCard(index) {
    // Önceki seçimi temizle
    document.querySelectorAll('.nft-card').forEach(card => {
      card.classList.remove('selected');
    });
    
    // Yeni seçimi işaretle
    const selectedCard = document.querySelector(`[data-index="${index}"]`);
    selectedCard.classList.add('selected');
    
    selectedNFT = userNFTs[index];
    selectNFTBtn.disabled = false;
  }

  // NFT seçimini onayla ve oyuna başla
  function confirmNFTSelection() {
    if (selectedNFT) {
      nftSelectionContainer.style.display = 'none';
      gameContainer.style.display = 'flex';
      initializeGame();
    }
  }

  // Hesap değişikliği dinleyicisi
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        // Bağlantı kesildi
        currentAccount = null;
        selectedNFT = null;
        walletStatus.style.display = 'none';
        gameContainer.style.display = 'none';
        nftSelectionContainer.style.display = 'none';
        metamaskContainer.style.display = 'flex';
        if (socket) {
          socket.disconnect();
        }
      } else if (accounts[0] !== currentAccount) {
        // Hesap değişti
        currentAccount = accounts[0];
        selectedNFT = null;
        showNFTSelection();
      }
    });
  }

  // Event listeners
  window.addEventListener('load', checkMetaMask);
  connectWalletBtn.addEventListener('click', connectWallet);
  selectNFTBtn.addEventListener('click', confirmNFTSelection);

  // Socket.io ve oyun değişkenleri
  let socket = null;
  
  // Oyuncu ve düşman barları
  const youHealthBar = document.getElementById('you-health');
  const youManaBar = document.getElementById('you-mana');
  const youHealthLabel = document.getElementById('you-health-label');
  const youManaLabel = document.getElementById('you-mana-label');
  const playerAvatar = document.getElementById('player-avatar');

  const enemyHealthBar = document.getElementById('enemy-health');
  const enemyManaBar = document.getElementById('enemy-mana');
  const enemyHealthLabel = document.getElementById('enemy-health-label');
  const enemyManaLabel = document.getElementById('enemy-mana-label');
  const enemyAvatar = document.getElementById('enemy-avatar');

  const statusDiv = document.getElementById('status');
  const victoryMessage = document.getElementById('victory-message');
  const victorySound = document.getElementById('victory-sound');

  const backToMenuBtn = document.getElementById('back-to-menu-btn');
  const playAgainBtn = document.getElementById('play-again-btn');

  const attackBtn = document.getElementById('attack-btn');
  const defendBtn = document.getElementById('defend-btn');
  const skillBtn = document.getElementById('skill-btn');
  const manaBtn = document.getElementById('mana-btn');
  const hydraBtn = document.getElementById('hydra-btn');

  // Chat elemanları
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const charCount = document.getElementById('char-count');

  // NFT bilgi elemanları
  const yourNFTInfo = document.getElementById('your-nft-info');
  const enemyNFTInfo = document.getElementById('enemy-nft-info');
  const yourBaseHealth = document.getElementById('your-base-health');
  const yourAttack = document.getElementById('your-attack');
  const yourDefense = document.getElementById('your-defense');
  const enemyBaseHealth = document.getElementById('enemy-base-health');
  const enemyAttack = document.getElementById('enemy-attack');
  const enemyDefense = document.getElementById('enemy-defense');

  let yourIndex = null;
  let yourData = null;
  let enemyData = null;
  let yourTurn = false;
  let gameActive = false;
  let initialHealth = 200;
  let yourNFTStats = null;
  let enemyNFTStats = null;

  // Oyunu başlatma fonksiyonu
  function initializeGame() {
    // Socket.io bağlantısını kur
    socket = io("https://pvpbackend.onrender.com");

    // Seçilen NFT'nin statlarını hesapla
    yourNFTStats = calculateNFTStats(selectedNFT);
    
    // NFT bilgilerini göster
    yourNFTInfo.textContent = selectedNFT.name;
    yourBaseHealth.textContent = yourNFTStats.health;
    yourAttack.textContent = yourNFTStats.attack;
    yourDefense.textContent = yourNFTStats.defense;
    
    // NFT avatarını ayarla
    playerAvatar.src = selectedNFT.image;

    function updateBars() {
      if(!yourData || !enemyData) return;

      // Sağlık barı güncellemesi (yüzde hesabı ile)
      const yourHealthPercent = (yourData.health / yourNFTStats.health) * 100;
      const enemyHealthPercent = (enemyData.health / (enemyNFTStats ? enemyNFTStats.health : initialHealth)) * 100;
      
      youHealthBar.style.width = yourHealthPercent + '%';
      enemyHealthBar.style.width = enemyHealthPercent + '%';

      youManaBar.style.width = (yourData.mana / 100 * 100) + '%';
      enemyManaBar.style.width = (enemyData.mana / 100 * 100) + '%';

      youHealthLabel.textContent = `Health: ${yourData.health}`;
      enemyHealthLabel.textContent = `Health: ${enemyData.health}`;

      youManaLabel.textContent = `Mana: ${yourData.mana}`;
      enemyManaLabel.textContent = `Mana: ${enemyData.mana}`;
      
      // HYDRA efektlerini güncelle
      if (yourData.hydraActive > 0) {
        document.querySelector('#you .character').classList.add('hydra-active');
      } else {
        document.querySelector('#you .character').classList.remove('hydra-active');
      }
      
      if (enemyData.hydraActive > 0) {
        document.querySelector('#enemy .character').classList.add('hydra-active');
      } else {
        document.querySelector('#enemy .character').classList.remove('hydra-active');
      }
    }

    function updateButtonStatus() {
      const disabled = !yourTurn || !gameActive;
      
      // NFT statlarına göre mana maliyetlerini ayarla
      const attackCost = Math.max(5, 15 - Math.floor(yourNFTStats.speed / 10));
      const defendCost = Math.max(3, 8 - Math.floor(yourNFTStats.defense / 8));
      const skillCost = Math.max(10, 25 - Math.floor(yourNFTStats.attack / 8));
      const ultimateCost = Math.max(20, 35 - Math.floor(yourNFTStats.attack / 5));
      
      attackBtn.disabled = disabled || (yourData && yourData.mana < attackCost);
      defendBtn.disabled = disabled || (yourData && yourData.mana < defendCost);
      skillBtn.disabled = disabled || (yourData && yourData.mana < skillCost);
      hydraBtn.disabled = disabled || (yourData && yourData.mana < ultimateCost) || (yourData && yourData.hydraUsed);
      manaBtn.disabled = disabled;
      
      // Button tooltiplerini güncelle
      attackBtn.title = `Attack (Costs ${attackCost} Mana, Deals ${yourNFTStats.attack} dmg)`;
      defendBtn.title = `Defend (Costs ${defendCost} Mana, Heals ${Math.floor(yourNFTStats.defense * 2)} hp)`;
      skillBtn.title = `Skill (Costs ${skillCost} Mana, Deals ${yourNFTStats.attack * 2} dmg)`;
      hydraBtn.title = `Ultimate (Costs ${ultimateCost} Mana, Multi-turn damage)`;
    }

    function showDamageNumber(element, amount, type = 'damage') {
      const damageElement = document.createElement('div');
      damageElement.className = type === 'damage' ? 'damage-number' : 
                               type === 'heal' ? 'heal-number' : 'mana-number';
      damageElement.textContent = type === 'damage' ? `-${amount}` : `+${amount}`;
      
      const rect = element.getBoundingClientRect();
      damageElement.style.left = (rect.left + rect.width / 2) + 'px';
      damageElement.style.top = (rect.top + rect.height / 2) + 'px';
      
      document.body.appendChild(damageElement);
      
      setTimeout(() => {
        if (damageElement.parentNode) {
          damageElement.parentNode.removeChild(damageElement);
        }
      }, 800);
    }

    function addChatMessage(message, sender = 'system') {
      const messageElement = document.createElement('div');
      messageElement.className = `chat-message ${sender}`;
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Socket olayları
    socket.on('connect', () => {
      console.log('Connected to server');
      addChatMessage('Connected to server', 'system');
      
      // Oyuna katılma - NFT bilgileri ile
      socket.emit('playerMove', { 
        move: 'join',
        walletAddress: currentAccount,
        nftData: {
          tokenId: selectedNFT.tokenId,
          name: selectedNFT.name,
          image: selectedNFT.image,
          stats: yourNFTStats
        }
      });
    });

    socket.on('waitingForOpponent', () => {
      statusDiv.textContent = 'Waiting for opponent...';
      addChatMessage('Waiting for opponent...', 'system');
    });

    socket.on('gameStart', (data) => {
      yourIndex = data.yourIndex;
      yourData = data.you;
      enemyData = data.enemy;
      gameActive = true;
      yourTurn = yourIndex === 0;
      
      // Düşman NFT bilgilerini güncelle
      if (data.enemyNFTData) {
        enemyNFTStats = data.enemyNFTData.stats;
        enemyNFTInfo.textContent = data.enemyNFTData.name;
        enemyBaseHealth.textContent = enemyNFTStats.health;
        enemyAttack.textContent = enemyNFTStats.attack;
        enemyDefense.textContent = enemyNFTStats.defense;
        enemyAvatar.src = data.enemyNFTData.image;
      }
      
      updateBars();
      updateButtonStatus();
      
      statusDiv.textContent = yourTurn ? 'Your turn!' : 'Enemy\'s turn';
      addChatMessage('Game started! NFT battle begins!', 'system');
    });

    socket.on('moveConfirmed', (data) => {
      yourData = data.you;
      enemyData = data.enemy;
      yourTurn = false;
      
      updateBars();
      updateButtonStatus();
      statusDiv.textContent = 'Enemy\'s turn';
      
      // Efekt gösterimi - NFT statlarına göre
      const damage = data.damageDealt || 0;
      if (damage > 0) {
        showDamageNumber(document.getElementById('enemy'), damage, 'damage');
        document.getElementById('enemy').classList.add('shake-animation');
        setTimeout(() => {
          document.getElementById('enemy').classList.remove('shake-animation');
        }, 500);
      }
      
      if (data.move === 'defend') {
        const healAmount = data.healAmount || Math.floor(yourNFTStats.defense * 2);
        showDamageNumber(document.getElementById('you'), healAmount, 'heal');
      } else if (data.move === 'mana') {
        showDamageNumber(document.getElementById('you'), 15, 'mana');
      }
    });

    socket.on('enemyMove', (data) => {
      yourData = data.you;
      enemyData = data.enemy;
      yourTurn = true;
      
      updateBars();
      updateButtonStatus();
      statusDiv.textContent = 'Your turn!';
      
      // Efekt gösterimi
      const damage = data.damageDealt || 0;
      if (damage > 0) {
        showDamageNumber(document.getElementById('you'), damage, 'damage');
        document.getElementById('you').classList.add('shake-animation');
        setTimeout(() => {
          document.getElementById('you').classList.remove('shake-animation');
        }, 500);
      }
      
      if (data.move === 'defend') {
        const healAmount = data.healAmount || 10;
        showDamageNumber(document.getElementById('enemy'), healAmount, 'heal');
      } else if (data.move === 'mana') {
        showDamageNumber(document.getElementById('enemy'), 15, 'mana');
      }
    });

    socket.on('gameOver', (data) => {
      gameActive = false;
      updateButtonStatus();
      
      if (data.winner === 'player') {
        victoryMessage.textContent = 'Victory!';
        victoryMessage.style.color = '#2ecc71';
        if (victorySound) {
          victorySound.play().catch(e => console.log('Audio play failed:', e));
        }
        // NFT experience kazanma mesajı
        addChatMessage(`Victory! Your ${selectedNFT.name} gained experience!`, 'system');
      } else {
        victoryMessage.textContent = 'Defeat!';
        victoryMessage.style.color = '#e74c3c';
        addChatMessage(`Defeat! Better luck next time with ${selectedNFT.name}!`, 'system');
      }
      
      victoryMessage.style.display = 'block';
      backToMenuBtn.style.display = 'block';
      playAgainBtn.style.display = 'block';
      
      statusDiv.textContent = 'Game Over';
    });

    socket.on('chatMessage', (data) => {
      const sender = data.fromIndex === yourIndex ? 'you' : 'enemy';
      addChatMessage(data.message, sender);
    });

    socket.on('errorMessage', (message) => {
      addChatMessage(`Error: ${message}`, 'system');
    });

    // Oyun kontrolleri - NFT statlarına göre
    attackBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { 
          move: 'attack',
          nftStats: yourNFTStats
        });
      }
    });

    defendBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { 
          move: 'defend',
          nftStats: yourNFTStats
        });
      }
    });

    skillBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { 
          move: 'skill',
          nftStats: yourNFTStats
        });
      }
    });

    manaBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { move: 'mana' });
      }
    });

    hydraBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { 
          move: 'hydra',
          nftStats: yourNFTStats
        });
      }
    });

    // Oyun sonu kontrolleri
    backToMenuBtn.addEventListener('click', () => {
      location.reload();
    });

    playAgainBtn.addEventListener('click', () => {
      victoryMessage.style.display = 'none';
      backToMenuBtn.style.display = 'none';
      playAgainBtn.style.display = 'none';
      
      socket.emit('playerMove', { 
        move: 'join',
        walletAddress: currentAccount,
        nftData: {
          tokenId: selectedNFT.tokenId,
          name: selectedNFT.name,
          image: selectedNFT.image,
          stats: yourNFTStats
        }
      });
    });

    // Chat kontrolleri
    chatInput.addEventListener('input', () => {
      const length = chatInput.value.length;
      charCount.textContent = `${length}/20`;
      chatSendBtn.disabled = length === 0;
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !chatSendBtn.disabled) {
        sendChatMessage();
      }
    });

    chatSendBtn.addEventListener('click', sendChatMessage);

    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (message && socket) {
        socket.emit('chatMessage', { message: message });
        addChatMessage(message, 'you');
        chatInput.value = '';
        charCount.textContent = '0/20';
        chatSendBtn.disabled = true;
      }
    }
  }
</script>
</body>
</html>
