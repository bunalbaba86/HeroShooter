<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFT PvP Turn-Based Game + Chat</title>
<style>
  /* CSS kodları aynı kalıyor... */
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  
  #container {
    display: flex;
    width: 900px;
    max-width: 100vw;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
  }
  
  #game {
    flex: 2;
    padding: 20px;
    position: relative;
  }
  
  /* MetaMask Connection Styles */
  #metamask-container, #nft-selection-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  #metamask-modal, #nft-selection-modal {
    background: #333;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  #connect-wallet-btn {
    background: #f6851b;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: background 0.3s;
  }
  
  #connect-wallet-btn:hover {
    background: #e2761b;
  }
  
  #connect-wallet-btn:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  /* NFT Selection Styles */
  #nft-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  
  .nft-card {
    background: #444;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .nft-card:hover {
    transform: scale(1.05);
    border-color: #3498db;
  }
  
  .nft-card.selected {
    border-color: #2ecc71;
    background: #2d5a2d;
  }
  
  .nft-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 5px;
    margin-bottom: 10px;
    background: #666;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
  }
  
  .spinner {
    border: 3px solid #444;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .wallet-status {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #444;
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 12px;
    color: #4CAF50;
  }
  
  /* Diğer CSS'ler aynı kalıyor... */
</style>
</head>
<body>

<!-- MetaMask Connection Modal -->
<div id="metamask-container">
  <div id="metamask-modal">
    <h2>Connect Your Wallet</h2>
    <p>You need to connect your MetaMask wallet to play this game.</p>
    <div id="metamask-status">
      <p id="connection-status">Please install MetaMask or connect your wallet.</p>
    </div>
    <button id="connect-wallet-btn">Connect MetaMask</button>
  </div>
</div>

<!-- NFT Selection Modal -->
<div id="nft-selection-container" style="display: none;">
  <div id="nft-selection-modal">
    <h2>Select Your NFT Character</h2>
    <p>Choose an NFT from the collection to use as your character:</p>
    <div id="nft-loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <span style="margin-left: 10px;">Loading your NFTs...</span>
    </div>
    <div id="nft-error" style="display: none; color: #e74c3c; margin: 20px 0;"></div>
    <div id="nft-grid"></div>
    <button id="select-nft-btn" disabled>Select Character</button>
    <button id="refresh-nfts-btn" style="margin-left: 10px; background: #f39c12;">Refresh NFTs</button>
  </div>
</div>

<!-- Wallet Status Display -->
<div class="wallet-status" id="wallet-status" style="display: none;">
  Connected: <span id="connected-address"></span>
</div>

<div id="container" style="display: none;">
  <div id="game">
    <div class="player-area">
      <div class="player" id="you">
        <div class="player-nft-info your-nft-info" id="your-nft-info">Your NFT</div>
        <div class="player-stats" id="your-stats">
          <span class="stat health-stat">HP: <span id="your-base-health">100</span></span>
          <span class="stat attack-stat">ATK: <span id="your-attack">10</span></span>
          <span class="stat defense-stat">DEF: <span id="your-defense">5</span></span>
        </div>
        <img src="" alt="Your NFT" class="character" id="player-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="you-health" style="width: 100%;"></div>
          <div class="bar-label" id="you-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="you-mana" style="width: 100%;"></div>
          <div class="bar-label" id="you-mana-label">Mana: 0</div>
        </div>
      </div>

      <div class="player" id="enemy">
        <div class="player-nft-info enemy-nft-info" id="enemy-nft-info">Enemy NFT</div>
        <div class="player-stats" id="enemy-stats">
          <span class="stat health-stat">HP: <span id="enemy-base-health">100</span></span>
          <span class="stat attack-stat">ATK: <span id="enemy-attack">10</span></span>
          <span class="stat defense-stat">DEF: <span id="enemy-defense">5</span></span>
        </div>
        <img src="" alt="Enemy NFT" class="character" id="enemy-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="enemy-health" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="enemy-mana" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-mana-label">Mana: 0</div>
        </div>
      </div>
    </div>

    <div id="actions">
      <button class="action-btn" id="attack-btn" title="Attack">
        <img src="attack.png" alt="Attack" /><br />
        Attack
      </button>
      <button class="action-btn" id="defend-btn" title="Defend">
        <img src="defend.png" alt="Defend" /><br />
        Defend
      </button>
      <button class="action-btn" id="skill-btn" title="Special Skill">
        <img src="skill.png" alt="Skill" /><br />
        Skill
      </button>
      <button class="action-btn" id="mana-btn" title="Restore Mana">
        <img src="mana.png" alt="Mana" /><br />
        Mana
      </button>
      <button class="action-btn" id="hydra-btn" title="Ultimate Attack">
        <img src="hydra.png" alt="Hydra" /><br />
        Ultimate
      </button>
    </div>

    <div id="status"></div>

    <div id="victory-message">Victory!</div>
    <button id="back-to-menu-btn">Back To Menu</button>
    <button id="play-again-btn">Play Again</button>
  </div>

  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Write message... (max 20 chars)" autocomplete="off" maxlength="20" />
      <span id="char-count">0/20</span>
      <button id="chat-send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<!-- Socket.io ve Ethers.js yükle -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
  // Global değişkenler
  let currentAccount = null;
  let provider = null;
  let signer = null;
  let selectedNFT = null;
  let userNFTs = [];
  let socket = null;

  // NFT Contract Address
  const NFT_CONTRACT_ADDRESS = "0xdfdb045e4300d04ec32058756ec2453409360c5b";
  
  // ERC721 ABI (sadece gerekli fonksiyonlar)
  const ERC721_ABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
    "function tokenURI(uint256 tokenId) view returns (string)",
    "function ownerOf(uint256 tokenId) view returns (address)"
  ];

  // DOM elemanları
  const metamaskContainer = document.getElementById('metamask-container');
  const nftSelectionContainer = document.getElementById('nft-selection-container');
  const connectWalletBtn = document.getElementById('connect-wallet-btn');
  const connectionStatus = document.getElementById('connection-status');
  const walletStatus = document.getElementById('wallet-status');
  const connectedAddress = document.getElementById('connected-address');
  const gameContainer = document.getElementById('container');
  const nftGrid = document.getElementById('nft-grid');
  const selectNFTBtn = document.getElementById('select-nft-btn');
  const refreshNFTsBtn = document.getElementById('refresh-nfts-btn');
  const nftLoading = document.getElementById('nft-loading');
  const nftError = document.getElementById('nft-error');

  // NFT özelliklerinden oyun statları hesaplama
  function calculateNFTStats(nft) {
    let health = 150;
    let attack = 15;
    let defense = 5;
    let speed = 10;

    const tokenIdNum = parseInt(nft.tokenId) || 0;
    
    // Token ID bazlı stat hesaplama
    const healthMod = (tokenIdNum * 7) % 50;
    const attackMod = (tokenIdNum * 11) % 25;
    const defenseMod = (tokenIdNum * 13) % 15;
    const speedMod = (tokenIdNum * 17) % 20;
    
    health += healthMod;
    attack += Math.floor(attackMod / 2);
    defense += Math.floor(defenseMod / 3);
    speed += Math.floor(speedMod / 2);

    // Rarity bonusu
    const rarityValue = tokenIdNum % 100;
    
    if (rarityValue >= 95) {
      health += 50;
      attack += 12;
      defense += 8;
      nft.rarity = "Legendary";
    } else if (rarityValue >= 80) {
      health += 30;
      attack += 8;
      defense += 5;
      nft.rarity = "Epic";
    } else if (rarityValue >= 50) {
      health += 20;
      attack += 5;
      defense += 3;
      nft.rarity = "Rare";
    } else {
      nft.rarity = "Common";
    }

    return {
      health: Math.min(health, 300),
      attack: Math.min(attack, 50),
      defense: Math.min(defense, 25),
      speed: Math.min(speed, 35)
    };
  }

  // MetaMask kontrolü
  async function checkMetaMask() {
    try {
      // Ethers.js yüklenmiş mi kontrol et
      if (typeof ethers === 'undefined') {
        connectionStatus.textContent = 'Loading Web3 libraries...';
        setTimeout(checkMetaMask, 1000);
        return;
      }

      if (typeof window.ethereum !== 'undefined') {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        connectWalletBtn.textContent = 'Connect MetaMask';
        connectWalletBtn.disabled = false;
        
        // Önceden bağlı hesapları kontrol et
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            currentAccount = accounts[0];
            signer = provider.getSigner();
            showNFTSelection();
          } else {
            connectionStatus.textContent = 'Please connect your MetaMask wallet.';
          }
        } catch (error) {
          console.log('Account check error:', error);
          connectionStatus.textContent = 'Please connect your MetaMask wallet.';
        }
      } else {
        connectionStatus.textContent = 'MetaMask is not installed. Please install MetaMask to continue.';
        connectWalletBtn.textContent = 'Install MetaMask';
        connectWalletBtn.onclick = () => {
          window.open('https://metamask.io/', '_blank');
        };
      }
    } catch (error) {
      console.error('MetaMask check error:', error);
      connectionStatus.textContent = 'Error checking MetaMask. Please refresh the page.';
    }
  }

  // MetaMask'a bağlanma fonksiyonu
  async function connectWallet() {
    try {
      // Ethers.js kontrol
      if (typeof ethers === 'undefined') {
        connectionStatus.textContent = 'Web3 libraries not loaded. Please refresh the page.';
        return;
      }

      connectWalletBtn.disabled = true;
      connectWalletBtn.textContent = 'Connecting...';
      
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts',
      });
      
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        showNFTSelection();
      } else {
        throw new Error('No accounts returned');
      }
    } catch (error) {
      console.error('Wallet connection failed:', error);
      connectionStatus.textContent = 'Connection failed. Please try again.';
      connectWalletBtn.disabled = false;
      connectWalletBtn.textContent = 'Connect MetaMask';
    }
  }

  // NFT seçim ekranını göster
  async function showNFTSelection() {
    try {
      metamaskContainer.style.display = 'none';
      nftSelectionContainer.style.display = 'flex';
      
      // Adresi göster
      const shortAddress = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
      connectedAddress.textContent = shortAddress;
      walletStatus.style.display = 'block';
      
      // NFT'leri yükle
      await loadUserNFTs();
    } catch (error) {
      console.error('Error showing NFT selection:', error);
      nftError.textContent = 'Error loading NFT selection. Creating demo NFTs...';
      nftError.style.display = 'block';
      createDemoNFTs();
    }
  }

  // Kullanıcının NFT'lerini yükle
  async function loadUserNFTs() {
    try {
      nftLoading.style.display = 'flex';
      nftError.style.display = 'none';
      nftGrid.innerHTML = '';
      userNFTs = [];
      
      console.log('Loading NFTs for address:', currentAccount);
      console.log('Contract address:', NFT_CONTRACT_ADDRESS);
      
      // Provider kontrol
      if (!provider) {
        throw new Error('Provider not initialized');
      }

      // NFT kontratına bağlan
      const nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, ERC721_ABI, provider);
      
      // Kullanıcının sahip olduğu NFT sayısını al
      const balance = await nftContract.balanceOf(currentAccount);
      console.log('NFT Balance:', balance.toString());
      
      if (balance.eq(0)) {
        throw new Error('You don\'t own any NFTs from this collection');
      }
      
      // İlk 10 NFT'yi yükle (performans için)
      const maxLoad = Math.min(balance.toNumber(), 10);
      
      for (let i = 0; i < maxLoad; i++) {
        try {
          // Token ID'yi al
          const tokenId = await nftContract.tokenOfOwnerByIndex(currentAccount, i);
          console.log(`Token ${i}:`, tokenId.toString());
          
          // NFT objesini oluştur
          const nft = {
            tokenId: tokenId.toString(),
            name: `NFT #${tokenId.toString()}`,
            description: '',
            image: `https://picsum.photos/150/150?random=${tokenId.toString()}`,
            traits: []
          };
          
          // Token URI'yi al (opsiyonel)
          try {
            const tokenURI = await nftContract.tokenURI(tokenId);
            if (tokenURI && tokenURI.startsWith('http')) {
              const response = await fetch(tokenURI);
              const metadata = await response.json();
              
              nft.name = metadata.name || nft.name;
              nft.description = metadata.description || '';
              nft.image = metadata.image || nft.image;
              nft.traits = metadata.attributes || [];
              
              // IPFS linklerini düzelt
              if (nft.image.startsWith('ipfs://')) {
                nft.image = nft.image.replace('ipfs://', 'https://ipfs.io/ipfs/');
              }
            }
          } catch (uriError) {
            console.log('Token URI error for token', tokenId.toString(), ':', uriError);
            // Varsayılan değerlerle devam et
          }
          
          userNFTs.push(nft);
          
        } catch (tokenError) {
          console.error(`Error loading token ${i}:`, tokenError);
        }
      }
      
      if (userNFTs.length === 0) {
        throw new Error('Could not load any NFT metadata');
      }
      
      console.log('Loaded NFTs:', userNFTs);
      displayNFTs();
      
    } catch (error) {
      console.error('Error loading NFTs:', error);
      nftError.textContent = `Error: ${error.message}. Creating demo NFTs for testing...`;
      nftError.style.display = 'block';
      
      // 3 saniye sonra demo NFT'ler oluştur
      setTimeout(() => {
        createDemoNFTs();
      }, 3000);
      
    } finally {
      nftLoading.style.display = 'none';
    }
  }

  // Demo NFT'ler oluştur
  function createDemoNFTs() {
    const demoCount = 6;
    userNFTs = [];
    
    for (let i = 1; i <= demoCount; i++) {
      const nft = {
        tokenId: i.toString(),
        name: `Demo Warrior #${i}`,
        image: `https://picsum.photos/150/150?random=${i + 100}`,
        traits: [
          { trait_type: "Strength", value: (Math.random() * 100).toFixed(0) },
          { trait_type: "Speed", value: (Math.random() * 100).toFixed(0) },
          { trait_type: "Power", value: (Math.random() * 100).toFixed(0) }
        ]
      };
      userNFTs.push(nft);
    }
    
    console.log('Created demo NFTs:', userNFTs);
    displayNFTs();
    nftError.style.display = 'none';
  }

  // NFT'leri ekranda göster
  function displayNFTs() {
    nftGrid.innerHTML = '';
    
    userNFTs.forEach((nft, index) => {
      const stats = calculateNFTStats(nft);
      
      const nftCard = document.createElement('div');
      nftCard.className = 'nft-card';
      nftCard.dataset.index = index;
      
      nftCard.innerHTML = `
        <img src="${nft.image}" alt="${nft.name}" class="nft-image" 
             onerror="this.src='https://via.placeholder.com/150?text=NFT%20${nft.tokenId}'" />
        <div class="nft-info">
          <div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">${nft.name}</div>
          <div style="font-size: 10px; color: #aaa; margin-bottom: 5px;">${nft.rarity || 'Common'}</div>
          <div class="nft-stats">
            <span class="stat health-stat" style="font-size: 9px; padding: 1px 3px;">HP: ${stats.health}</span>
            <span class="stat attack-stat" style="font-size: 9px; padding: 1px 3px;">ATK: ${stats.attack}</span>
          </div>
          <div class="nft-stats">
            <span class="stat defense-stat" style="font-size: 9px; padding: 1px 3px;">DEF: ${stats.defense}</span>
            <span class="stat speed-stat" style="font-size: 9px; padding: 1px 3px;">SPD: ${stats.speed}</span>
          </div>
        </div>
      `;
      
      nftCard.addEventListener('click', () => selectNFTCard(index));
      nftGrid.appendChild(nftCard);
    });
  }

  // NFT kartı seçimi
  function selectNFTCard(index) {
    // Önceki seçimi temizle
    document.querySelectorAll('.nft-card').forEach(card => {
      card.classList.remove('selected');
    });
    
    // Yeni seçimi işaretle
    const selectedCard = document.querySelector(`[data-index="${index}"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
      selectedNFT = userNFTs[index];
      selectNFTBtn.disabled = false;
    }
  }

  // NFT seçimini onayla ve oyuna başla
  function confirmNFTSelection() {
    if (selectedNFT) {
      nftSelectionContainer.style.display = 'none';
      gameContainer.style.display = 'flex';
      initializeGame();
    }
  }

  // NFT'leri yenile
  async function refreshNFTs() {
    selectedNFT = null;
    selectNFTBtn.disabled = true;
    await loadUserNFTs();
  }

  // Hesap değişikliği dinleyicisi
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        currentAccount = null;
        selectedNFT = null;
        provider = null;
        signer = null;
        walletStatus.style.display = 'none';
        gameContainer.style.display = 'none';
        nftSelectionContainer.style.display = 'none';
        metamaskContainer.style.display = 'flex';
        if (socket) {
          socket.disconnect();
        }
      } else if (accounts[0] !== currentAccount) {
        currentAccount = accounts[0];
        selectedNFT = null;
        if (provider) {
          signer = provider.getSigner();
          showNFTSelection();
        }
      }
    });
  }

  // Event listeners
  window.addEventListener('load', () => {
    // 1 saniye bekle, sonra MetaMask kontrol et
    setTimeout(checkMetaMask, 1000);
  });
  
  connectWalletBtn.addEventListener('click', connectWallet);
  selectNFTBtn.addEventListener('click', confirmNFTSelection);
  refreshNFTsBtn.addEventListener('click', refreshNFTs);

  // Oyun başlatma fonksiyonu
  function initializeGame() {
    console.log('Starting game with NFT:', selectedNFT);
    
    // Socket bağlantısı
    socket = io();

    // Seçilen NFT'nin statlarını hesapla
    const yourNFTStats = calculateNFTStats(selectedNFT);
    
    // NFT bilgilerini göster
    document.getElementById('your-nft-info').textContent = selectedNFT.name;
    document.getElementById('your-base-health').textContent = yourNFTStats.health;
    document.getElementById('your-attack').textContent = yourNFTStats.attack;
    document.getElementById('your-defense').textContent = yourNFTStats.defense;
    
    // NFT avatarını ayarla
    document.getElementById('player-avatar').src = selectedNFT.image;

    // Socket event handlers
    socket.on('connect', () => {
      console.log('Connected to server');
      addChatMessage('Connected to server', 'system');
      
      // NFT ile oyuna katıl
      socket.emit('playerMove', { 
        move: 'join',
        walletAddress: currentAccount,
        selectedNFT: selectedNFT
      });
    });

    socket.on('waitingForOpponent', () => {
      document.getElementById('status').textContent = 'Waiting for opponent...';
      addChatMessage('Waiting for opponent...', 'system');
    });

    socket.on('gameStart', (data) => {
      console.log('Game started:', data);
      
      // Enemy NFT bilgilerini göster
      if (data.enemyNFT) {
        const enemyStats = calculateNFTStats(data.enemyNFT);
        document.getElementById('enemy-nft-info').textContent = data.enemyNFT.name;
        document.getElementById('enemy-base-health').textContent = enemyStats.health;
        document.getElementById('enemy-attack').textContent = enemyStats.attack;
        document.getElementById('enemy-defense').textContent = enemyStats.defense;
        document.getElementById('enemy-avatar').src = data.enemyNFT.image;
      }
      
      addChatMessage('Game started!', 'system');
    });

    // Chat mesaj fonksiyonu
    function addChatMessage(message, sender = 'system') {
      const chatMessages = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      messageElement.className = `chat-message ${sender}`;
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Diğer socket event'ler ve oyun logikleri buraya eklenebilir...
  }
</script>
</body>
</html>
