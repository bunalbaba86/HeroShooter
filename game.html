<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Kryptomon Battle Arena</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(45deg, #2c3e50, #3498db);
    color: white;
    height: 100vh;
    overflow: hidden;
  }

  .screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
  }

  .hidden {
    display: none !important;
  }

  /* Start Screen */
  #start-screen {
    background: rgba(0,0,0,0.9);
    text-align: center;
  }

  #start-screen h1 {
    font-size: 3em;
    margin-bottom: 20px;
    color: #FFD700;
  }

  #start-screen input {
    padding: 15px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    margin: 10px 0;
    width: 300px;
    text-align: center;
  }

  #start-screen button {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    margin: 10px;
    cursor: pointer;
    width: 300px;
    font-weight: bold;
  }

  #start-btn {
    background: #2ecc71;
    color: white;
  }

  #guest-btn {
    background: #95a5a6;
    color: white;
  }

  /* Waiting Screen */
  #waiting-screen {
    background: rgba(0,0,0,0.9);
    text-align: center;
  }

  #waiting-screen h2 {
    font-size: 2em;
    margin-bottom: 20px;
    color: #FFD700;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Game Screen */
  #game-screen {
    background: url('background.png') center/cover,
                linear-gradient(45deg, #8B4513, #D2691E);
  }

  .game-ui {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 15px;
    border-radius: 15px;
    text-align: center;
    min-width: 300px;
  }

  .hp-bars {
    position: absolute;
    top: 100px;
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
  }

  .hp-bar {
    background: rgba(0,0,0,0.8);
    padding: 10px;
    border-radius: 10px;
    min-width: 200px;
  }

  .hp-bar h3 {
    margin-bottom: 10px;
    color: #FFD700;
  }

  .bar {
    background: #333;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
  }

  .bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #27ae60, #2ecc71);
    transition: width 0.5s ease;
  }

  .mp-fill {
    background: linear-gradient(90deg, #3498db, #2980b9);
  }

  .battle-area {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    gap: 100px;
  }

  .kryptomon {
    width: 200px;
    height: 200px;
    background: #333;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4em;
    border: 3px solid #FFD700;
    transition: all 0.3s ease;
  }

  .kryptomon.enemy {
    transform: scaleX(-1);
  }

  .kryptomon.attacking {
    animation: attack 1s ease-in-out;
  }

  @keyframes attack {
    0% { transform: translateX(0) scale(1); }
    50% { transform: translateX(30px) scale(1.1); }
    100% { transform: translateX(0) scale(1); }
  }

  .controls {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    width: 90%;
    max-width: 400px;
  }

  .control-btn {
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .control-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .control-btn:not(:disabled):active {
    transform: scale(0.95);
  }

  .control-btn small {
    font-size: 10px;
    opacity: 0.8;
  }

  .mana-cost {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
  }

  .mana-gain {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
  }

  .status {
    position: absolute;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    padding: 10px 20px;
    border-radius: 10px;
    text-align: center;
    color: #FFD700;
    font-weight: bold;
  }

  /* Connection Status */
  .connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
  }

  .connected { background: #2ecc71; }
  .disconnected { background: #e74c3c; }
  .connecting { background: #f39c12; }

  @media (max-width: 768px) {
    .battle-area {
      gap: 50px;
    }
    
    .kryptomon {
      width: 150px;
      height: 150px;
      font-size: 3em;
    }
    
    .hp-bars {
      flex-direction: column;
      gap: 10px;
      top: 80px;
    }
    
    .hp-bar {
      align-self: center;
    }
  }
</style>
</head>
<body>
  <!-- Connection Status -->
  <div id="connection-status" class="connection-status disconnected">Disconnected</div>

  <!-- Start Screen -->
  <div id="start-screen" class="screen">
    <h1>üêæ Kryptomon Battle</h1>
    <p>Enter your name to start fighting!</p>
    <input type="text" id="player-name" placeholder="Your Name" maxlength="20">
    <br>
    <button id="start-btn" disabled>Start Game</button>
    <button id="guest-btn">Play as Guest</button>
  </div>

  <!-- Waiting Screen -->
  <div id="waiting-screen" class="screen hidden">
    <h2>Finding Opponent...</h2>
    <div class="spinner"></div>
    <p>Player: <span id="waiting-name"></span></p>
    <p>Please wait while we find you an opponent</p>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="screen hidden">
    <!-- Game UI -->
    <div class="game-ui">
      <div id="turn-info">Turn: Player 1</div>
      <div id="timer">30s</div>
    </div>

    <!-- HP Bars -->
    <div class="hp-bars">
      <div class="hp-bar">
        <h3 id="your-name">You</h3>
        <div>HP: <span id="your-hp">100</span>/100</div>
        <div class="bar"><div class="bar-fill" id="your-hp-bar" style="width: 100%"></div></div>
        <div>MP: <span id="your-mp">100</span>/100</div>
        <div class="bar"><div class="bar-fill mp-fill" id="your-mp-bar" style="width: 100%"></div></div>
      </div>

      <div class="hp-bar">
        <h3 id="enemy-name">Enemy</h3>
        <div>HP: <span id="enemy-hp">100</span>/100</div>
        <div class="bar"><div class="bar-fill" id="enemy-hp-bar" style="width: 100%"></div></div>
        <div>MP: <span id="enemy-mp">100</span>/100</div>
        <div class="bar"><div class="bar-fill mp-fill" id="enemy-mp-bar" style="width: 100%"></div></div>
      </div>
    </div>

    <!-- Battle Area -->
    <div class="battle-area">
      <div class="kryptomon" id="your-kryptomon">üê≤</div>
      <div class="kryptomon enemy" id="enemy-kryptomon">üêâ</div>
    </div>

    <!-- Status -->
    <div class="status" id="status">Your Turn</div>

    <!-- Controls -->
    <div class="controls">
      <button class="control-btn mana-cost" id="attack-btn">
        ‚öîÔ∏è Attack
        <small>-10 MP</small>
      </button>

      <button class="control-btn mana-cost" id="defend-btn">
        üõ°Ô∏è Defend
        <small>-5 MP</small>
      </button>

      <button class="control-btn mana-cost" id="skill-btn">
        ‚ú® Skill
        <small>-20 MP</small>
      </button>

      <button class="control-btn mana-cost" id="ultimate-btn">
        üí• Ultimate
        <small>-40 MP</small>
      </button>

      <button class="control-btn mana-gain" id="mana-btn">
        üîÆ Restore
        <small>+25 MP</small>
      </button>

      <button class="control-btn" id="surrender-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
        üè≥Ô∏è Surrender
      </button>
    </div>
  </div>

<script>
console.log('üéÆ Kryptomon Battle Arena Starting...');

// Game state
const gameState = {
  socket: null,
  connected: false,
  playerName: '',
  inGame: false,
  yourIndex: null,
  gameData: null,
  yourTurn: false
};

// DOM elements
const startScreen = document.getElementById('start-screen');
const waitingScreen = document.getElementById('waiting-screen');
const gameScreen = document.getElementById('game-screen');
const connectionStatus = document.getElementById('connection-status');
const playerNameInput = document.getElementById('player-name');
const startBtn = document.getElementById('start-btn');
const guestBtn = document.getElementById('guest-btn');

// Game elements
const yourName = document.getElementById('your-name');
const enemyName = document.getElementById('enemy-name');
const yourHp = document.getElementById('your-hp');
const yourMp = document.getElementById('your-mp');
const enemyHp = document.getElementById('enemy-hp');
const enemyMp = document.getElementById('enemy-mp');
const yourHpBar = document.getElementById('your-hp-bar');
const yourMpBar = document.getElementById('your-mp-bar');
const enemyHpBar = document.getElementById('enemy-hp-bar');
const enemyMpBar = document.getElementById('enemy-mp-bar');
const yourKryptomon = document.getElementById('your-kryptomon');
const enemyKryptomon = document.getElementById('enemy-kryptomon');
const turnInfo = document.getElementById('turn-info');
const status = document.getElementById('status');

// Control buttons
const attackBtn = document.getElementById('attack-btn');
const defendBtn = document.getElementById('defend-btn');
const skillBtn = document.getElementById('skill-btn');
const ultimateBtn = document.getElementById('ultimate-btn');
const manaBtn = document.getElementById('mana-btn');
const surrenderBtn = document.getElementById('surrender-btn');

// Initialize
function init() {
  console.log('Initializing game...');
  
  // Enable start button when name is entered
  playerNameInput.addEventListener('input', () => {
    startBtn.disabled = playerNameInput.value.trim().length < 2;
  });

  // Start game button
  startBtn.addEventListener('click', () => {
    const name = playerNameInput.value.trim();
    if (name.length >= 2) {
      gameState.playerName = name;
      startGame();
    }
  });

  // Guest mode button
  guestBtn.addEventListener('click', () => {
    gameState.playerName = playerNameInput.value.trim() || `Guest_${Math.floor(Math.random() * 1000)}`;
    startGame();
  });

  // Control buttons
  attackBtn.addEventListener('click', () => sendMove('attack'));
  defendBtn.addEventListener('click', () => sendMove('defend'));
  skillBtn.addEventListener('click', () => sendMove('skill'));
  ultimateBtn.addEventListener('click', () => sendMove('ultimate'));
  manaBtn.addEventListener('click', () => sendMove('manaRestore'));
  surrenderBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to surrender?')) {
      sendMove('surrender');
    }
  });
}

// Start game
function startGame() {
  console.log('Starting game for:', gameState.playerName);
  showWaitingScreen();
  connectToServer();
}

// Connect to server
function connectToServer() {
  updateConnectionStatus('connecting');
  
  // Use environment-based URL
  const serverUrl = window.location.hostname === 'localhost' 
    ? 'http://localhost:3000' 
    : 'https://pvpbackend.onrender.com';
  
  console.log('Connecting to:', serverUrl);
  
  gameState.socket = io(serverUrl, {
    withCredentials: true,
    timeout: 15000,
    transports: ['websocket', 'polling']
  });

  gameState.socket.on('connect', () => {
    console.log('‚úÖ Connected to server');
    gameState.connected = true;
    updateConnectionStatus('connected');
    
    // Join game immediately
    gameState.socket.emit('joinGame', {
      username: gameState.playerName,
      isGuest: true
    });
  });

  gameState.socket.on('disconnect', () => {
    console.log('‚ùå Disconnected from server');
    gameState.connected = false;
    updateConnectionStatus('disconnected');
  });

  gameState.socket.on('connect_error', (error) => {
    console.error('‚ùå Connection error:', error);
    updateConnectionStatus('disconnected');
    alert('Could not connect to server. Please try again.');
  });

  // Game events
  gameState.socket.on('waitingForOpponent', (data) => {
    console.log('‚è≥ Waiting for opponent:', data);
    document.getElementById('waiting-name').textContent = gameState.playerName;
  });

  gameState.socket.on('gameStartCountdown', (data) => {
    console.log('‚è∞ Game starting in:', data.countdown);
    document.getElementById('waiting-screen').innerHTML = `
      <h2>Game Starting in ${data.countdown}...</h2>
      <div class="spinner"></div>
    `;
  });

  gameState.socket.on('gameStart', (data) => {
    console.log('üéÆ Game started:', data);
    gameState.inGame = true;
    gameState.yourIndex = data.yourIndex;
    gameState.gameData = data.gameRoom;
    showGameScreen();
    updateUI(data.gameRoom);
  });

  gameState.socket.on('turnResult', (data) => {
    console.log('üéØ Turn result:', data);
    gameState.gameData = data.gameRoom;
    updateUI(data.gameRoom);
    
    // Show attack animation
    if (data.result && data.result.moveType === 'attack') {
      const attacker = data.result.playerIndex === gameState.yourIndex ? yourKryptomon : enemyKryptomon;
      attacker.classList.add('attacking');
      setTimeout(() => attacker.classList.remove('attacking'), 1000);
    }
  });

  gameState.socket.on('gameEnd', (data) => {
    console.log('üèÅ Game ended:', data);
    const isWinner = data.winner === gameState.yourIndex;
    alert(isWinner ? 'üéâ You Won!' : 'üòû You Lost!');
    resetGame();
  });

  gameState.socket.on('error', (error) => {
    console.error('üö® Game error:', error);
    alert('Error: ' + error.message);
  });
}

// Send move to server
function sendMove(moveType) {
  if (!gameState.socket || !gameState.inGame || !gameState.yourTurn) {
    console.log('Cannot send move:', gameState.socket, gameState.inGame, gameState.yourTurn);
    return;
  }

  console.log('üì§ Sending move:', moveType);
  gameState.socket.emit('battleMove', { moveType });
}

// Update UI
function updateUI(gameRoom) {
  if (!gameRoom || gameState.yourIndex === null) return;

  const yourData = gameRoom.players[gameState.yourIndex];
  const enemyData = gameRoom.players[1 - gameState.yourIndex];
  
  // Update names
  yourName.textContent = yourData.username;
  enemyName.textContent = enemyData.username;
  
  // Get current Kryptomon
  const yourKryptomon = yourData.team[yourData.currentKryptomon];
  const enemyKryptomonData = enemyData.team[enemyData.currentKryptomon];
  
  if (yourKryptomon && enemyKryptomonData) {
    // Update HP/MP displays
    yourHp.textContent = yourKryptomon.hp;
    yourMp.textContent = yourKryptomon.mana;
    enemyHp.textContent = enemyKryptomonData.hp;
    enemyMp.textContent = enemyKryptomonData.mana;
    
    // Update bars
    yourHpBar.style.width = (yourKryptomon.hp / yourKryptomon.maxHp * 100) + '%';
    yourMpBar.style.width = (yourKryptomon.mana / yourKryptomon.maxMana * 100) + '%';
    enemyHpBar.style.width = (enemyKryptomonData.hp / enemyKryptomonData.maxHp * 100) + '%';
    enemyMpBar.style.width = (enemyKryptomonData.mana / enemyKryptomonData.maxMana * 100) + '%';
  }
  
  // Update turn
  gameState.yourTurn = gameRoom.currentTurn === gameState.yourIndex;
  turnInfo.textContent = gameState.yourTurn ? 'Your Turn' : 'Enemy Turn';
  status.textContent = gameState.yourTurn ? 'Choose your move!' : 'Waiting for enemy...';
  
  // Update buttons
  updateButtons();
}

// Update button states
function updateButtons() {
  const disabled = !gameState.yourTurn || !gameState.inGame;
  
  attackBtn.disabled = disabled;
  defendBtn.disabled = disabled;
  skillBtn.disabled = disabled;
  ultimateBtn.disabled = disabled;
  manaBtn.disabled = disabled;
  surrenderBtn.disabled = !gameState.inGame;
  
  // Add mana checks if we have current Kryptomon data
  if (gameState.gameData && gameState.yourIndex !== null) {
    const yourData = gameState.gameData.players[gameState.yourIndex];
    const currentKryptomon = yourData.team[yourData.currentKryptomon];
    
    if (currentKryptomon) {
      attackBtn.disabled = disabled || currentKryptomon.mana < 10;
      defendBtn.disabled = disabled || currentKryptomon.mana < 5;
      skillBtn.disabled = disabled || currentKryptomon.mana < 20;
      ultimateBtn.disabled = disabled || currentKryptomon.mana < 40 || currentKryptomon.ultimateUsed;
    }
  }
}

// Screen management
function showScreen(screen) {
  [startScreen, waitingScreen, gameScreen].forEach(s => s.classList.add('hidden'));
  screen.classList.remove('hidden');
}

function showWaitingScreen() {
  showScreen(waitingScreen);
}

function showGameScreen() {
  showScreen(gameScreen);
}

function resetGame() {
  gameState.inGame = false;
  gameState.yourIndex = null;
  gameState.gameData = null;
  gameState.yourTurn = false;
  showScreen(startScreen);
}

// Connection status
function updateConnectionStatus(status) {
  connectionStatus.className = `connection-status ${status}`;
  connectionStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
}

// Start the game
init();
console.log('üéÆ Game initialized!');
</script>
</body>
</html>
