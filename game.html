<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2c3e50">
<title>Kryptomon Battle Arena</title>

<!-- Socket.io CDN -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Arial', sans-serif;
    background: url('background.png') center/cover no-repeat fixed,
                linear-gradient(45deg, #8B4513, #D2691E);
    color: #fff;
    overflow: hidden;
    height: 100vh;
  }

  /* Dynamic backgrounds */
  body.bg1 {
    background: url('background.png') center/cover no-repeat fixed;
  }
  
  body.bg2 {
    background: url('background2.png') center/cover no-repeat fixed;
  }
  
  body.bg3 {
    background: url('background3.png') center/cover no-repeat fixed;
  }

  body.bg4 {
    background: url('background4.png') center/cover no-repeat fixed;
  }

  /* Connection Status */
  .connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
    transition: all 0.3s ease;
  }

  .connection-status.connected {
    background: #2ecc71;
    color: white;
  }

  .connection-status.disconnected {
    background: #e74c3c;
    color: white;
  }

  .connection-status.connecting {
    background: #f39c12;
    color: white;
  }

  .connection-status.error {
    background: #e74c3c;
    color: white;
  }

  /* Screen Rotation Prompt */
  .rotation-prompt {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    flex-direction: column;
    color: white;
    text-align: center;
  }

  .rotation-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: rotatePhone 2s infinite ease-in-out;
  }

  @keyframes rotatePhone {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(90deg); }
  }

  /* Player Name Selection Screen */
  #player-name-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  #player-name-modal {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  }

  #player-name-input {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border: 2px solid #3498db;
    border-radius: 10px;
    margin: 20px 0;
    background: rgba(255,255,255,0.9);
    color: #2c3e50;
    text-align: center;
  }

  #player-name-input:focus {
    outline: none;
    border-color: #2ecc71;
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
  }

  #set-name-btn {
    background: linear-gradient(45deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
    width: 100%;
  }

  #set-name-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
  }

  #set-name-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
  }

  /* Guest Mode Button */
  #guest-mode-btn {
    background: linear-gradient(45deg, #95a5a6, #7f8c8d);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s ease;
    margin-top: 10px;
  }

  #guest-mode-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
  }

  /* MetaMask Connection Modal */
  #metamask-container, #nft-selection-container, #waiting-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  #metamask-modal, #nft-selection-modal {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 900px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  }

  /* Player name displays */
  .player-name-display {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
  }

  .game-player-name {
    position: absolute;
    bottom: -50px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 8px 15px;
    border-radius: 15px;
    font-size: 14px;
    font-weight: bold;
    color: #FFD700;
    border: 2px solid rgba(255,215,0,0.5);
    backdrop-filter: blur(5px);
  }

  .trainer.left .game-player-name {
    left: 30px;
    transform: none;
  }

  .trainer.right .game-player-name {
    right: 30px;
    left: auto;
    transform: none;
  }

  /* Waiting for Opponent Screen */
  #waiting-container {
    background: linear-gradient(45deg, rgba(0,0,0,0.8), rgba(50,50,50,0.9));
    backdrop-filter: blur(10px);
  }

  .waiting-screen {
    text-align: center;
    color: #fff;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .waiting-split {
    display: flex;
    width: 100%;
    height: 100vh;
    position: relative;
  }

  .waiting-left, .waiting-right {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
    padding: 50px 20px;
  }

  .waiting-left {
    background: linear-gradient(45deg, rgba(52, 152, 219, 0.3), rgba(41, 128, 185, 0.5));
    border-right: 4px solid rgba(255,255,255,0.3);
  }

  .waiting-right {
    background: linear-gradient(45deg, rgba(231, 76, 60, 0.3), rgba(192, 57, 43, 0.5));
  }

  .vs-divider {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 100px;
    color: #FFD700;
    text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    z-index: 10;
    animation: pulse 2s infinite;
  }

  .waiting-player-icon {
    font-size: 120px;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
  }

  .waiting-player-name {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
  }

  .waiting-status {
    font-size: 18px;
    margin-bottom: 20px;
  }

  .question-mark {
    font-size: 150px;
    color: #ccc;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
  }

  /* Game Start Countdown */
  .game-start-countdown {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 120px;
    color: #FFD700;
    font-weight: bold;
    text-shadow: 0 0 40px rgba(255, 215, 0, 1);
    z-index: 5000;
    animation: countdownPulse 1s infinite;
    background: rgba(0,0,0,0.9);
    padding: 30px 50px;
    border-radius: 25px;
    border: 4px solid #FFD700;
    backdrop-filter: blur(10px);
  }

  @keyframes countdownPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
  }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-20px); }
    60% { transform: translateY(-10px); }
  }

  @keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
  }

  #connect-wallet-btn, #select-nft-btn, #refresh-nfts-btn {
    background: linear-gradient(45deg, #f6851b, #ff6b35);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
  }

  #connect-wallet-btn:hover, #select-nft-btn:hover, #refresh-nfts-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(246, 133, 27, 0.4);
  }

  /* NFT Selection Grid */
  #nft-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 25px 0;
  }

  .nft-card {
    background: rgba(60, 60, 60, 0.9);
    border-radius: 15px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
  }

  .nft-card:hover {
    transform: translateY(-5px);
    border-color: #3498db;
  }

  .nft-card.selected {
    border-color: #2ecc71;
    background: rgba(46, 204, 113, 0.2);
  }

  .nft-image {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 10px;
    background: #333;
  }

  /* Game Arena */
  #game-container {
    width: 100vw;
    height: 100vh;
    position: relative;
    display: none;
  }

  .dojo-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.4) 100%);
    backdrop-filter: blur(1px);
  }

  /* Turn Info */
  .turn-info {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    backdrop-filter: blur(10px);
    border: 2px solid #FFD700;
    z-index: 100;
    text-align: center;
  }

  .turn-timer {
    color: #FFD700;
    font-size: 18px;
    margin-top: 5px;
  }

  /* HP Bars - Top of screen */
  .hp-bar-container {
    position: absolute;
    top: 80px;
    background: rgba(0,0,0,0.9);
    padding: 15px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.2);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 15px;
    min-width: 300px;
  }

  .hp-bar-container.left {
    left: 30px;
  }

  .hp-bar-container.right {
    right: 30px;
  }

  .hp-kryptomon-image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #FFD700;
    object-fit: cover;
    background: #333;
  }

  .hp-stats {
    flex: 1;
  }

  .hp-stat {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px;
  }

  .hp-stat:last-child {
    margin-bottom: 0;
  }

  .hp-stat-icon {
    width: 24px;
    height: 24px;
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .hp-stat-icon::before {
    content: '‚ù§Ô∏è';
  }

  .hp-stat-value {
    color: white;
    font-weight: bold;
    min-width: 80px;
    text-align: left;
  }

  .hp-bar-modern {
    background: rgba(255,255,255,0.2);
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    flex: 1;
    position: relative;
  }

  .hp-fill-modern {
    background: linear-gradient(90deg, #e74c3c 0%, #27ae60 100%);
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 10px;
  }

  /* Character Images with Profile Photos */
  .character-image {
    position: absolute;
    bottom: 20px;
    background: rgba(0,0,0,0.9);
    padding: 15px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.2);
    z-index: 100;
    min-width: 300px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .character-image.left {
    left: 30px;
  }

  .character-image.right {
    right: 30px;
  }

  .character-profile-image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #FFD700;
    object-fit: cover;
    background: #333;
  }

  .character-info {
    flex: 1;
  }

  .character-mana {
    margin-top: 10px;
  }

  .mana-stat {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .mana-stat-icon {
    width: 24px;
    height: 24px;
    background: linear-gradient(45deg, #3498db, #2980b9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .mana-stat-icon::before {
    content: '‚ö°';
  }

  /* Mana sadece rakam olacak */
  .mana-stat-value {
    color: #3498db;
    font-weight: bold;
    font-size: 24px;
    text-align: center;
    min-width: 60px;
  }

  /* Battle Arena */
  .battle-arena {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    height: 40%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
  }

  .trainer {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Kryptomon sprite boyutu k√º√ß√ºlt√ºld√º */
  .kryptomon-sprite {
    width: 300px;
    height: 300px;
    object-fit: contain;
    transition: all 0.3s ease;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
  }

  /* Sol taraftaki Kryptomon saƒüa baksƒ±n (normal), saƒü taraftaki sola baksƒ±n (flipped) */
  .trainer.right .kryptomon-sprite {
    transform: scaleX(-1);
  }

  /* Attack Animations */
  .attack-animation {
    animation: attackMove 0.6s ease-in-out;
  }

  .skill-animation {
    animation: skillShake 0.8s ease-in-out;
  }

  .ultimate-animation {
    animation: ultimateBlast 1.2s ease-in-out;
  }

  @keyframes attackMove {
    0% { transform: translateX(0); }
    30% { transform: translateX(50px); }
    100% { transform: translateX(0); }
  }

  .trainer.right .attack-animation {
    animation: attackMoveRight 0.6s ease-in-out;
  }

  @keyframes attackMoveRight {
    0% { transform: translateX(0) scaleX(-1); }
    30% { transform: translateX(-50px) scaleX(-1); }
    100% { transform: translateX(0) scaleX(-1); }
  }

  @keyframes skillShake {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(-10px) rotate(-5deg); }
    75% { transform: translateX(10px) rotate(5deg); }
  }

  .trainer.right .skill-animation {
    animation: skillShakeRight 0.8s ease-in-out;
  }

  @keyframes skillShakeRight {
    0%, 100% { transform: translateX(0) scaleX(-1) rotate(0deg); }
    25% { transform: translateX(10px) scaleX(-1) rotate(5deg); }
    75% { transform: translateX(-10px) scaleX(-1) rotate(-5deg); }
  }

  @keyframes ultimateBlast {
    0% { transform: scale(1) rotate(0deg); filter: brightness(1) drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
    25% { transform: scale(1.3) rotate(10deg); filter: brightness(2) drop-shadow(0 0 30px rgba(255,215,0,0.8)); }
    50% { transform: scale(0.8) rotate(-10deg); filter: brightness(3) drop-shadow(0 0 50px rgba(255,0,0,0.8)); }
    75% { transform: scale(1.2) rotate(5deg); filter: brightness(2.5) drop-shadow(0 0 40px rgba(0,255,255,0.8)); }
    100% { transform: scale(1) rotate(0deg); filter: brightness(1) drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
  }

  .trainer.right .ultimate-animation {
    animation: ultimateBlastRight 1.2s ease-in-out;
  }

  @keyframes ultimateBlastRight {
    0% { transform: scale(1) scaleX(-1) rotate(0deg); filter: brightness(1) drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
    25% { transform: scale(1.3) scaleX(-1) rotate(-10deg); filter: brightness(2) drop-shadow(0 0 30px rgba(255,215,0,0.8)); }
    50% { transform: scale(0.8) scaleX(-1) rotate(10deg); filter: brightness(3) drop-shadow(0 0 50px rgba(255,0,0,0.8)); }
    75% { transform: scale(1.2) scaleX(-1) rotate(-5deg); filter: brightness(2.5) drop-shadow(0 0 40px rgba(0,255,255,0.8)); }
    100% { transform: scale(1) scaleX(-1) rotate(0deg); filter: brightness(1) drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
  }

  /* Kryptomon Switch Animation - geli≈ütirildi */
  .kryptomon-switch-animation {
    animation: magicalSwitchOut 1s ease-in-out;
  }

  .kryptomon-switch-animation.slide-in {
    animation: magicalSwitchIn 1s ease-in-out;
  }

  @keyframes magicalSwitchOut {
    0% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
      filter: brightness(1);
    }
    25% {
      transform: scale(1.2) rotate(90deg);
      opacity: 0.8;
      filter: brightness(2) hue-rotate(180deg);
    }
    50% {
      transform: scale(0.5) rotate(180deg);
      opacity: 0.3;
      filter: brightness(3) hue-rotate(360deg);
    }
    100% {
      transform: scale(0) rotate(360deg);
      opacity: 0;
      filter: brightness(1);
    }
  }

  @keyframes magicalSwitchIn {
    0% {
      transform: scale(0) rotate(-360deg);
      opacity: 0;
      filter: brightness(3) hue-rotate(360deg);
    }
    50% {
      transform: scale(0.5) rotate(-180deg);
      opacity: 0.3;
      filter: brightness(2) hue-rotate(180deg);
    }
    75% {
      transform: scale(1.2) rotate(-90deg);
      opacity: 0.8;
      filter: brightness(1.5) hue-rotate(90deg);
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
      filter: brightness(1);
    }
  }

  .trainer.right .kryptomon-switch-animation {
    animation: magicalSwitchOutRight 1s ease-in-out;
  }

  .trainer.right .kryptomon-switch-animation.slide-in {
    animation: magicalSwitchInRight 1s ease-in-out;
  }

  @keyframes magicalSwitchOutRight {
    0% {
      transform: scale(1) scaleX(-1) rotate(0deg);
      opacity: 1;
      filter: brightness(1);
    }
    25% {
      transform: scale(1.2) scaleX(-1) rotate(-90deg);
      opacity: 0.8;
      filter: brightness(2) hue-rotate(180deg);
    }
    50% {
      transform: scale(0.5) scaleX(-1) rotate(-180deg);
      opacity: 0.3;
      filter: brightness(3) hue-rotate(360deg);
    }
    100% {
      transform: scale(0) scaleX(-1) rotate(-360deg);
      opacity: 0;
      filter: brightness(1);
    }
  }

  @keyframes magicalSwitchInRight {
    0% {
      transform: scale(0) scaleX(-1) rotate(360deg);
      opacity: 0;
      filter: brightness(3) hue-rotate(360deg);
    }
    50% {
      transform: scale(0.5) scaleX(-1) rotate(180deg);
      opacity: 0.3;
      filter: brightness(2) hue-rotate(180deg);
    }
    75% {
      transform: scale(1.2) scaleX(-1) rotate(90deg);
      opacity: 0.8;
      filter: brightness(1.5) hue-rotate(90deg);
    }
    100% {
      transform: scale(1) scaleX(-1) rotate(0deg);
      opacity: 1;
      filter: brightness(1);
    }
  }

  /* Kryptomon Team Selection - d√ºzeltildi */
  .kryptomon-team {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 100;
  }

  .kryptomon-team.left {
    left: 20px;
  }

  .kryptomon-team.right {
    left: 20px; /* Saƒü taraf da soldan se√ßiyor */
  }

  .kryptomon-slot {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: hidden;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    position: relative;
  }

  .kryptomon-slot:hover:not(.dead) {
    border-color: #3498db;
    transform: scale(1.1);
  }

  .kryptomon-slot.active {
    border-color: #FFD700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
  }

  /* Kryptomon √∂l√º durumu - d√ºzeltildi */
  .kryptomon-slot.dead {
    opacity: 0.3;
    border-color: #e74c3c;
    cursor: not-allowed;
    pointer-events: none; /* √ñl√º Kryptomon se√ßilemesin */
  }

  .kryptomon-slot.dead::after {
    content: 'üíÄ';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    z-index: 10;
  }

  .kryptomon-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Game Controls */
  .game-controls {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    z-index: 100;
  }

  .control-btn {
    background: linear-gradient(45deg, #2c3e50, #34495e);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 15px 25px;
    border-radius: 15px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    position: relative;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  .control-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    border-color: #3498db;
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
  }

  .control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .control-btn.mana-gain::after {
    content: '+' attr(data-mana);
    position: absolute;
    top: -8px;
    right: -8px;
    background: #2ecc71;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .control-btn.mana-cost::after {
    content: '-' attr(data-mana);
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  /* Surrender and Emoji Buttons */
  .game-actions {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;
    gap: 10px;
    z-index: 200;
  }

  .surrender-btn, .emoji-btn {
    background: rgba(0,0,0,0.8);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .surrender-btn:hover {
    background: #e74c3c;
    border-color: #e74c3c;
  }

  .emoji-btn:hover {
    background: #f39c12;
    border-color: #f39c12;
  }

  /* Emoji Panel */
  .emoji-panel {
    position: absolute;
    top: 80px;
    left: 20px;
    background: rgba(0,0,0,0.9);
    padding: 20px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.2);
    z-index: 300;
    display: none;
  }

  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }

  .emoji-item {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .emoji-item:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.2);
  }

  /* Attack Effects */
  .damage-text {
    position: absolute;
    font-size: 36px;
    font-weight: bold;
    color: #e74c3c;
    text-shadow: 0 0 10px rgba(231, 76, 60, 0.8);
    animation: damageFloat 1.5s ease-out forwards;
    pointer-events: none;
    z-index: 1000;
  }

  .damage-text.critical {
    color: #f39c12;
    font-size: 48px;
    text-shadow: 0 0 15px rgba(243, 156, 18, 1);
    animation: criticalDamageFloat 1.8s ease-out forwards;
  }

  .damage-text.heal {
    color: #2ecc71;
    text-shadow: 0 0 10px rgba(46, 204, 113, 0.8);
  }

  @keyframes damageFloat {
    0% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(-80px) scale(1.2);
    }
  }

  @keyframes criticalDamageFloat {
    0% {
      opacity: 1;
      transform: translateY(0) scale(1) rotate(0deg);
    }
    25% {
      transform: translateY(-20px) scale(1.3) rotate(5deg);
    }
    50% {
      transform: translateY(-40px) scale(1.1) rotate(-5deg);
    }
    100% {
      opacity: 0;
      transform: translateY(-100px) scale(1.5) rotate(0deg);
    }
  }

  /* Shield Effect - savunan kryptomon √ºzerinde g√∂sterilecek */
  .shield-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 250px;
    height: 250px;
    background: radial-gradient(circle, rgba(52, 152, 219, 0.3) 0%, transparent 70%);
    border: 3px solid #3498db;
    border-radius: 50%;
    animation: shieldPulse 0.8s ease-out;
    pointer-events: none;
    z-index: 200;
  }

  @keyframes shieldPulse {
    0% {
      transform: translate(-50%, -50%) scale(0.5);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 0;
    }
  }

  /* Ultimate Effect - geli≈ütirilmi≈ü */
  .ultimate-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, 
      rgba(255, 215, 0, 0.8) 0%, 
      rgba(255, 0, 0, 0.6) 30%, 
      rgba(0, 255, 255, 0.4) 60%, 
      transparent 100%);
    border: 6px solid #FFD700;
    border-radius: 50%;
    animation: ultimateExplosion 1.5s ease-out;
    pointer-events: none;
    z-index: 200;
  }

  .ultimate-effect::before {
    content: '‚≠êüí•‚ö°';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 60px;
    animation: ultimateStars 1.5s ease-out;
  }

  @keyframes ultimateExplosion {
    0% {
      transform: translate(-50%, -50%) scale(0.2) rotate(0deg);
      opacity: 1;
      filter: brightness(3) hue-rotate(0deg);
    }
    25% {
      transform: translate(-50%, -50%) scale(0.8) rotate(90deg);
      opacity: 0.9;
      filter: brightness(4) hue-rotate(90deg);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
      opacity: 0.8;
      filter: brightness(5) hue-rotate(180deg);
    }
    75% {
      transform: translate(-50%, -50%) scale(1.5) rotate(270deg);
      opacity: 0.6;
      filter: brightness(3) hue-rotate(270deg);
    }
    100% {
      transform: translate(-50%, -50%) scale(2) rotate(360deg);
      opacity: 0;
      filter: brightness(1) hue-rotate(360deg);
    }
  }

  @keyframes ultimateStars {
    0% {
      transform: translate(-50%, -50%) scale(0) rotate(0deg);
      opacity: 1;
    }
    50% {
      transform: translate(-50%, -50%) scale(2) rotate(180deg);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(3) rotate(360deg);
      opacity: 0;
    }
  }

  /* Emoji Animation */
  .emoji-animation {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 80px;
    animation: emojiFloat 2s ease-out forwards;
    pointer-events: none;
    z-index: 1000;
  }

  @keyframes emojiFloat {
    0% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(0.5);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2);
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(1) translateY(-50px);
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hp-bar-container {
      min-width: 250px;
      padding: 10px;
    }
    
    .character-image {
      min-width: 250px;
      padding: 10px;
    }
    
    .battle-arena {
      width: 80%;
      height: 35%;
    }
    
    .kryptomon-sprite {
      width: 250px;
      height: 250px;
    }
    
    .game-controls {
      flex-wrap: wrap;
      max-width: 90%;
    }
    
    .control-btn {
      padding: 12px 20px;
      font-size: 14px;
    }
    
    .kryptomon-team {
      gap: 10px;
    }
    
    .kryptomon-slot {
      width: 60px;
      height: 60px;
    }
  }

  @media (max-width: 480px) {
    .hp-bar-container {
      min-width: 200px;
      padding: 8px;
      top: 70px;
    }
    
    .character-image {
      min-width: 200px;
      padding: 8px;
      bottom: 15px;
    }
    
    .kryptomon-sprite {
      width: 200px;
      height: 200px;
    }
    
    .game-controls {
      bottom: 20px;
    }
    
    .control-btn {
      padding: 10px 15px;
      font-size: 12px;
    }
    
    .turn-info {
      top: 15px;
      padding: 8px 15px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <!-- Connection Status -->
  <div id="connection-status" class="connection-status disconnected">Disconnected</div>

  <!-- Screen Rotation Prompt -->
  <div class="rotation-prompt" id="rotation-prompt">
    <div class="rotation-icon">üì±</div>
    <h2>Please Rotate Your Device</h2>
    <p>This game is best played in landscape mode</p>
  </div>

  <!-- Player Name Selection Screen -->
  <div id="player-name-container">
    <div id="player-name-modal">
      <h1>üêæ Kryptomon Battle Arena</h1>
      <p>Enter your player name to start battling!</p>
      <input type="text" id="player-name-input" placeholder="Enter your name" maxlength="20">
      <button id="set-name-btn" disabled>Connect Wallet & Select NFTs</button>
      <button id="guest-mode-btn">Play as Guest</button>
    </div>
  </div>

  <!-- MetaMask Connection Modal -->
  <div id="metamask-container">
    <div id="metamask-modal">
      <h2>ü¶ä Connect Your Wallet</h2>
      <p>Connect your MetaMask wallet to access your Kryptomon NFTs</p>
      <button id="connect-wallet-btn">Connect MetaMask</button>
    </div>
  </div>

  <!-- NFT Selection Modal -->
  <div id="nft-selection-container">
    <div id="nft-selection-modal">
      <h2>üéÆ Select Your Kryptomon Team</h2>
      <div class="player-name-display" id="nft-player-name">Player Name</div>
      <p>Choose up to 3 Kryptomon for battle:</p>
      <div id="nft-grid"></div>
      <div style="margin-top: 20px;">
        <button id="refresh-nfts-btn">üîÑ Refresh NFTs</button>
        <button id="select-nft-btn" disabled>Start Battle!</button>
      </div>
    </div>
  </div>

  <!-- Waiting for Opponent Screen -->
  <div id="waiting-container">
    <div class="waiting-screen">
      <div class="waiting-split">
        <div class="waiting-left">
          <div class="waiting-player-icon">üë§</div>
          <div class="waiting-player-name">You</div>
          <div class="waiting-status">Ready!</div>
        </div>
        
        <div class="vs-divider">VS</div>
        
        <div class="waiting-right">
          <div class="question-mark">?</div>
          <div class="waiting-player-name">Waiting...</div>
          <div class="waiting-status">Looking for opponent</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div class="dojo-bg"></div>
    
    <!-- Turn Info -->
    <div class="turn-info" id="turn-info">
      <div>Player 1's Turn</div>
      <div class="turn-timer" id="turn-timer">30s</div>
    </div>

    <!-- Game Actions (Surrender & Emoji) -->
    <div class="game-actions">
      <button class="surrender-btn" id="surrender-btn" title="Surrender">üè≥Ô∏è</button>
      <button class="emoji-btn" id="emoji-btn" title="Send Emoji">üòÄ</button>
    </div>

    <!-- Emoji Panel -->
    <div class="emoji-panel" id="emoji-panel">
      <div class="emoji-grid">
        <div class="emoji-item" data-emoji="üòÄ">üòÄ</div>
        <div class="emoji-item" data-emoji="üòé">üòé</div>
        <div class="emoji-item" data-emoji="üòà">üòà</div>
        <div class="emoji-item" data-emoji="ü§î">ü§î</div>
        <div class="emoji-item" data-emoji="üòÇ">üòÇ</div>
        <div class="emoji-item" data-emoji="üò≠">üò≠</div>
        <div class="emoji-item" data-emoji="üî•">üî•</div>
        <div class="emoji-item" data-emoji="‚ö°">‚ö°</div>
        <div class="emoji-item" data-emoji="üí™">üí™</div>
        <div class="emoji-item" data-emoji="üëè">üëè</div>
        <div class="emoji-item" data-emoji="ü§ù">ü§ù</div>
        <div class="emoji-item" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
      </div>
    </div>

    <!-- HP Bars -->
    <div class="hp-bar-container left" id="player-hp">
      <img src="kryptomon1.png" alt="Player Kryptomon" class="hp-kryptomon-image" id="player-hp-image">
      <div class="hp-stats">
        <div class="hp-stat">
          <div class="hp-stat-icon"></div>
          <div class="hp-stat-value" id="player-hp-text">100/100</div>
          <div class="hp-bar-modern">
            <div class="hp-fill-modern" id="player-hp-fill" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="hp-bar-container right" id="enemy-hp">
      <div class="hp-stats">
        <div class="hp-stat">
          <div class="hp-stat-icon"></div>
          <div class="hp-stat-value" id="enemy-hp-text">100/100</div>
          <div class="hp-bar-modern">
            <div class="hp-fill-modern" id="enemy-hp-fill" style="width: 100%"></div>
          </div>
        </div>
      </div>
      <img src="kryptomon2.png" alt="Enemy Kryptomon" class="hp-kryptomon-image" id="enemy-hp-image">
    </div>

    <!-- Character Images with Profile Photos -->
    <div class="character-image left" id="player-character">
      <img src="you.jpg" alt="Player Profile" class="character-profile-image" id="player-profile-img">
      <div class="character-info">
        <div class="game-player-name" id="player-name-display">Player 1</div>
        <div class="character-mana">
          <div class="mana-stat">
            <div class="mana-stat-icon"></div>
            <div class="mana-stat-value" id="player-mana">0</div>
          </div>
        </div>
      </div>
    </div>

    <div class="character-image right" id="enemy-character">
      <div class="character-info">
        <div class="game-player-name" id="enemy-name-display">Player 2</div>
        <div class="character-mana">
          <div class="mana-stat">
            <div class="mana-stat-icon"></div>
            <div class="mana-stat-value" id="enemy-mana">0</div>
          </div>
        </div>
      </div>
      <img src="enemy.jpg" alt="Enemy Profile" class="character-profile-image" id="enemy-profile-img">
    </div>

    <!-- Battle Arena -->
    <div class="battle-arena">
      <!-- Player Kryptomon -->
      <div class="trainer left" id="player-trainer">
        <img src="kryptomon1.png" alt="Player Kryptomon" class="kryptomon-sprite" id="player-kryptomon">
      </div>

      <!-- Enemy Kryptomon -->
      <div class="trainer right" id="enemy-trainer">
        <img src="kryptomon2.png" alt="Enemy Kryptomon" class="kryptomon-sprite" id="enemy-kryptomon">
      </div>
    </div>

    <!-- Kryptomon Team Selection - Her iki taraf da soldan se√ßiyor -->
    <div class="kryptomon-team left" id="player-team">
      <div class="kryptomon-slot active" data-index="0">
        <img src="kryptomon1.png" alt="Kryptomon 1">
      </div>
      <div class="kryptomon-slot" data-index="1">
        <img src="kryptomon2.png" alt="Kryptomon 2">
      </div>
      <div class="kryptomon-slot" data-index="2">
        <img src="kryptomon3.png" alt="Kryptomon 3">
      </div>
    </div>

    <div class="kryptomon-team left" id="enemy-team" style="left: 120px;">
      <div class="kryptomon-slot active" data-index="0">
        <img src="kryptomon4.png" alt="Kryptomon 1">
      </div>
      <div class="kryptomon-slot" data-index="1">
        <img src="kryptomon5.png" alt="Kryptomon 2">
      </div>
      <div class="kryptomon-slot" data-index="2">
        <img src="kryptomon6.png" alt="Kryptomon 3">
      </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
      <button class="control-btn mana-gain" id="attack-btn" data-mana="2">‚öîÔ∏è Attack</button>
      <button class="control-btn" id="defend-btn">üõ°Ô∏è Defend</button>
      <button class="control-btn mana-cost" id="skill-btn" data-mana="2">‚≠ê Skill</button>
      <button class="control-btn mana-cost" id="ultimate-btn" data-mana="6">üí• Ultimate</button>
    </div>
  </div>

<script>
// Game variables
let socket = null;
let gameState = null;
let yourIndex = -1;
let playerName = '';
let isGuestMode = false;
let selectedKryptomon = [];
let audioContext = null;
let sounds = {};

// Initialize audio system
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  // Preload sound effects
  const soundFiles = {
    attack: 'bite.mp3',
    defend: 'defence.mp3', 
    skill: 'skill.mp3',
    ultimate: 'ultimate.mp3',
    victory: 'victory.mp3',
    switch: 'switch.mp3'
  };
  
  Object.keys(soundFiles).forEach(key => {
    loadSound(key, soundFiles[key]);
  });
}

function loadSound(name, url) {
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(data => audioContext.decodeAudioData(data))
    .then(buffer => {
      sounds[name] = buffer;
    })
    .catch(error => {
      console.log(`Could not load sound ${url}:`, error);
    });
}

function playSound(name) {
  if (sounds[name] && audioContext) {
    const source = audioContext.createBufferSource();
    source.buffer = sounds[name];
    source.connect(audioContext.destination);
    source.start(0);
  }
}

// DOM elements
const playerNameContainer = document.getElementById('player-name-container');
const playerNameInput = document.getElementById('player-name-input');
const setNameBtn = document.getElementById('set-name-btn');
const guestModeBtn = document.getElementById('guest-mode-btn');
const metamaskContainer = document.getElementById('metamask-container');
const connectWalletBtn = document.getElementById('connect-wallet-btn');
const nftSelectionContainer = document.getElementById('nft-selection-container');
const nftGrid = document.getElementById('nft-grid');
const selectNftBtn = document.getElementById('select-nft-btn');
const refreshNftsBtn = document.getElementById('refresh-nfts-btn');
const waitingContainer = document.getElementById('waiting-container');
const gameContainer = document.getElementById('game-container');

// Connection status
const connectionStatus = document.getElementById('connection-status');

function updateConnectionStatus(status) {
  connectionStatus.className = `connection-status ${status}`;
  switch(status) {
    case 'connected':
      connectionStatus.textContent = 'Connected';
      break;
    case 'connecting':
      connectionStatus.textContent = 'Connecting...';
      break;
    case 'disconnected':
      connectionStatus.textContent = 'Disconnected';
      break;
    case 'error':
      connectionStatus.textContent = 'Connection Error';
      break;
  }
}

// Initialize game
function initGame() {
  console.log('üéÆ Initializing Kryptomon Battle Arena...');
  
  // Initialize audio
  initAudio();
  
  // Setup event listeners
  setupEventListeners();
  
  // Initialize socket connection
  initSocket();
  
  // Start with player name input
  showPlayerNameInput();
}

function setupEventListeners() {
  // Player name input
  playerNameInput.addEventListener('input', function() {
    const name = this.value.trim();
    setNameBtn.disabled = name.length < 2;
    if (name.length >= 2) {
      setNameBtn.textContent = 'Connect Wallet & Select NFTs';
    }
  });

  playerNameInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !setNameBtn.disabled) {
      setNameBtn.click();
    }
  });

  setNameBtn.addEventListener('click', function() {
    playerName = playerNameInput.value.trim();
    if (playerName.length >= 2) {
      showMetaMaskConnection();
    }
  });

  // Guest mode button - d√ºzeltildi
  guestModeBtn.addEventListener('click', function() {
    console.log('üéØ Guest mode clicked');
    playerName = playerNameInput.value.trim() || 'Guest_' + Math.random().toString(36).substr(2, 5);
    isGuestMode = true;
    
    // Guest mode i√ßin varsayƒ±lan Kryptomon takƒ±mƒ±
    selectedKryptomon = [
      { tokenId: '978', name: 'Guest Kryptomon 1', image: 'kryptomon1.png' },
      { tokenId: '979', name: 'Guest Kryptomon 2', image: 'kryptomon2.png' },
      { tokenId: '980', name: 'Guest Kryptomon 3', image: 'kryptomon3.png' }
    ];
    
    console.log('üîÑ Starting matchmaking for guest:', playerName);
    startMatchmaking();
  });

  // MetaMask connection
  connectWalletBtn.addEventListener('click', connectWallet);

  // NFT selection
  refreshNftsBtn.addEventListener('click', loadNFTs);
  selectNftBtn.addEventListener('click', function() {
    if (selectedKryptomon.length >= 1) {
      startMatchmaking();
    }
  });

  // Game controls
  document.getElementById('attack-btn').addEventListener('click', () => makeMove('attack'));
  document.getElementById('defend-btn').addEventListener('click', () => makeMove('defend'));
  document.getElementById('skill-btn').addEventListener('click', () => makeMove('skill'));
  document.getElementById('ultimate-btn').addEventListener('click', () => makeMove('ultimate'));
  
  // Surrender button
  document.getElementById('surrender-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to surrender?')) {
      socket.emit('surrender');
    }
  });

  // Emoji system
  const emojiBtn = document.getElementById('emoji-btn');
  const emojiPanel = document.getElementById('emoji-panel');
  
  emojiBtn.addEventListener('click', function() {
    emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
  });

  document.querySelectorAll('.emoji-item').forEach(item => {
    item.addEventListener('click', function() {
      const emoji = this.dataset.emoji;
      socket.emit('sendEmoji', { emoji });
      emojiPanel.style.display = 'none';
    });
  });

  // Close emoji panel when clicking outside
  document.addEventListener('click', function(e) {
    if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
      emojiPanel.style.display = 'none';
    }
  });

  // Kryptomon team selection - d√ºzeltildi
  document.querySelectorAll('#player-team .kryptomon-slot').forEach(slot => {
    slot.addEventListener('click', function() {
      if (this.classList.contains('dead')) return; // √ñl√º Kryptomon se√ßilemesin
      
      const index = parseInt(this.dataset.index);
      if (gameState && gameState.currentTurn === yourIndex) {
        makeMove('switch', index);
      }
    });
  });
}

function initSocket() {
  updateConnectionStatus('connecting');
  
  const serverUrl = 'https://pvpbackend.onrender.com';
  
  try {
    socket = io(serverUrl, {
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: true,
      timeout: 30000,
      forceNew: true
    });

    socket.on('connect', function() {
      console.log('‚úÖ Connected to server');
      updateConnectionStatus('connected');
    });

    socket.on('disconnect', function() {
      console.log('‚ùå Disconnected from server');
      updateConnectionStatus('disconnected');
    });

    socket.on('connect_error', function(error) {
      console.error('‚ùå Connection error:', error);
      updateConnectionStatus('error');
    });

    socket.on('waitingForOpponent', function(data) {
      console.log('‚è≥ Waiting for opponent:', data);
      showWaitingScreen();
    });

    socket.on('matchFound', function(data) {
      console.log('üÜö Match found!', data);
      yourIndex = data.yourIndex;
      
      // Set background
      if (data.background) {
        setBackground(data.background);
      }
    });

    socket.on('gameCountdown', function(countdown) {
      console.log('‚è∞ Game countdown:', countdown);
      showGameCountdown(countdown);
    });

    socket.on('gameStart', function(data) {
      console.log('üéÆ Game started!', data);
      gameState = data.gameState;
      yourIndex = data.yourIndex;
      
      // Set background
      if (data.background) {
        setBackground(data.background);
      }
      
      startGame(data);
    });

    socket.on('gameUpdate', function(data) {
      console.log('üîÑ Game update:', data);
      gameState = data.gameState;
      updateGameUI(data);
    });

    socket.on('gameEnd', function(data) {
      console.log('üèÜ Game ended:', data);
      endGame(data);
    });

    socket.on('opponentEmoji', function(data) {
      showEmojiAnimation(data.emoji);
    });

    socket.on('opponentDisconnected', function(data) {
      alert('Opponent disconnected! You win!');
      if (data.winner !== undefined) {
        endGame({ winner: data.winner, winnerName: 'You' });
      }
    });

  } catch (error) {
    console.error('‚ùå Socket initialization error:', error);
    updateConnectionStatus('error');
  }
}

function showPlayerNameInput() {
  playerNameContainer.style.display = 'flex';
  metamaskContainer.style.display = 'none';
  nftSelectionContainer.style.display = 'none';
  waitingContainer.style.display = 'none';
  gameContainer.style.display = 'none';
}

function showMetaMaskConnection() {
  playerNameContainer.style.display = 'none';
  metamaskContainer.style.display = 'flex';
}

function showNFTSelection() {
  metamaskContainer.style.display = 'none';
  nftSelectionContainer.style.display = 'flex';
  document.getElementById('nft-player-name').textContent = playerName;
  loadNFTs();
}

function showWaitingScreen() {
  nftSelectionContainer.style.display = 'none';
  waitingContainer.style.display = 'flex';
  
  // Update waiting screen with player name
  document.querySelector('.waiting-player-name').textContent = playerName;
}

function showGameCountdown(count) {
  waitingContainer.style.display = 'none';
  gameContainer.style.display = 'block';
  
  // Create countdown element
  const countdownEl = document.createElement('div');
  countdownEl.className = 'game-start-countdown';
  countdownEl.textContent = count;
  document.body.appendChild(countdownEl);
  
  // Remove countdown after 1 second
  setTimeout(() => {
    if (countdownEl.parentNode) {
      countdownEl.parentNode.removeChild(countdownEl);
    }
  }, 1000);
}

async function connectWallet() {
  try {
    if (typeof window.ethereum !== 'undefined') {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      if (accounts.length > 0) {
        console.log('ü¶ä MetaMask connected:', accounts[0]);
        showNFTSelection();
      }
    } else {
      alert('MetaMask is not installed. Please install MetaMask or use Guest Mode.');
    }
  } catch (error) {
    console.error('‚ùå MetaMask connection error:', error);
    alert('Failed to connect MetaMask. Please try again or use Guest Mode.');
  }
}

function loadNFTs() {
  console.log('üîÑ Loading NFTs...');
  
  // Mock NFT data
  const mockNFTs = [
    { tokenId: '1001', name: 'Fire Dragon', image: 'kryptomon1.png', rarity: 'Epic' },
    { tokenId: '1002', name: 'Water Serpent', image: 'kryptomon2.png', rarity: 'Rare' },
    { tokenId: '1003', name: 'Earth Golem', image: 'kryptomon3.png', rarity: 'Common' },
    { tokenId: '1004', name: 'Air Phoenix', image: 'kryptomon4.png', rarity: 'Legendary' },
    { tokenId: '1005', name: 'Shadow Wolf', image: 'kryptomon5.png', rarity: 'Epic' },
    { tokenId: '1006', name: 'Light Unicorn', image: 'kryptomon6.png', rarity: 'Rare' }
  ];

  nftGrid.innerHTML = '';
  
  mockNFTs.forEach(nft => {
    const nftCard = document.createElement('div');
    nftCard.className = 'nft-card';
    nftCard.innerHTML = `
      <img src="${nft.image}" alt="${nft.name}" class="nft-image">
      <h3>${nft.name}</h3>
      <p>ID: ${nft.tokenId}</p>
      <p>Rarity: ${nft.rarity}</p>
    `;
    
    nftCard.addEventListener('click', function() {
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        selectedKryptomon = selectedKryptomon.filter(k => k.tokenId !== nft.tokenId);
      } else if (selectedKryptomon.length < 3) {
        this.classList.add('selected');
        selectedKryptomon.push(nft);
      } else {
        alert('You can only select up to 3 Kryptomon!');
      }
      
      selectNftBtn.disabled = selectedKryptomon.length === 0;
      selectNftBtn.textContent = `Start Battle! (${selectedKryptomon.length}/3)`;
    });
    
    nftGrid.appendChild(nftCard);
  });
}

function startMatchmaking() {
  console.log('üéØ Starting matchmaking...');
  
  const playerData = {
    playerName: playerName,
    walletAddress: isGuestMode ? 'guest' : 'wallet_address',
    selectedKryptomon: selectedKryptomon,
    isGuestMode: isGuestMode
  };
  
  console.log('üì§ Sending findMatch:', playerData);
  socket.emit('findMatch', playerData);
}

function setBackground(backgroundFile) {
  const bgMap = {
    'background.png': 'bg1',
    'background2.png': 'bg2', 
    'background3.png': 'bg3',
    'background4.png': 'bg4'
  };
  
  const bgClass = bgMap[backgroundFile] || 'bg1';
  document.body.className = bgClass;
}

function startGame(data) {
  console.log('üéÆ Starting game with data:', data);
  
  waitingContainer.style.display = 'none';
  gameContainer.style.display = 'block';
  
  // Set player names
  document.getElementById('player-name-display').textContent = 
    yourIndex === 0 ? data.gameState.players[0].playerName : data.gameState.players[1].playerName;
  document.getElementById('enemy-name-display').textContent = 
    yourIndex === 0 ? data.gameState.players[1].playerName : data.gameState.players[0].playerName;
  
  // Initialize Kryptomon teams
  initializeKryptomonTeams(data.gameState);
  
  // Update UI
  updateGameUI(data);
  
  console.log('‚úÖ Game UI initialized');
}

function initializeKryptomonTeams(gameState) {
  const playerData = gameState.gameData[yourIndex];
  const enemyData = gameState.gameData[1 - yourIndex];
  
  // Update player team slots
  const playerTeamSlots = document.querySelectorAll('#player-team .kryptomon-slot');
  playerTeamSlots.forEach((slot, index) => {
    const kryptomon = playerData.kryptomonTeam[index];
    if (kryptomon) {
      const img = slot.querySelector('img');
      img.src = kryptomon.image;
      img.alt = kryptomon.name;
      
      // Mark active Kryptomon
      if (index === playerData.activeKryptomon) {
        slot.classList.add('active');
      } else {
        slot.classList.remove('active');
      }
      
      // Mark dead Kryptomon
      if (kryptomon.isDead) {
        slot.classList.add('dead');
      } else {
        slot.classList.remove('dead');
      }
    }
  });
  
  // Update enemy team slots  
  const enemyTeamSlots = document.querySelectorAll('#enemy-team .kryptomon-slot');
  enemyTeamSlots.forEach((slot, index) => {
    const kryptomon = enemyData.kryptomonTeam[index];
    if (kryptomon) {
      const img = slot.querySelector('img');
      img.src = kryptomon.image;
      img.alt = kryptomon.name;
      
      // Mark active Kryptomon
      if (index === enemyData.activeKryptomon) {
        slot.classList.add('active');
      } else {
        slot.classList.remove('active');
      }
      
      // Mark dead Kryptomon
      if (kryptomon.isDead) {
        slot.classList.add('dead');
      } else {
        slot.classList.remove('dead');
      }
    }
  });
}

function updateGameUI(data) {
  if (!gameState) return;
  
  const playerData = gameState.gameData[yourIndex];
  const enemyData = gameState.gameData[1 - yourIndex];
  
  // Update HP bars
  updateHPBar('player', playerData);
  updateHPBar('enemy', enemyData);
  
  // Update mana
  document.getElementById('player-mana').textContent = playerData.mana;
  document.getElementById('enemy-mana').textContent = enemyData.mana;
  
  // Update Kryptomon sprites
  updateKryptomonSprites(playerData, enemyData);
  
  // Update turn info
  updateTurnInfo();
  
  // Update control buttons
  updateControlButtons(playerData);
  
  // Update team status
  initializeKryptomonTeams(gameState);
  
  // Handle move result
  if (data.lastMoveResult) {
    handleMoveResult(data.lastMoveResult);
  }
}

function updateHPBar(type, data) {
  const hpText = document.getElementById(`${type}-hp-text`);
  const hpFill = document.getElementById(`${type}-hp-fill`);
  const hpImage = document.getElementById(`${type}-hp-image`);
  
  const activeKryptomon = data.kryptomonTeam[data.activeKryptomon];
  
  hpText.textContent = `${data.health}/${data.maxHealth}`;
  hpFill.style.width = `${(data.health / data.maxHealth) * 100}%`;
  
  if (activeKryptomon) {
    hpImage.src = activeKryptomon.image;
  }
}

function updateKryptomonSprites(playerData, enemyData) {
  const playerSprite = document.getElementById('player-kryptomon');
  const enemySprite = document.getElementById('enemy-kryptomon');
  
  const playerActiveKryptomon = playerData.kryptomonTeam[playerData.activeKryptomon];
  const enemyActiveKryptomon = enemyData.kryptomonTeam[enemyData.activeKryptomon];
  
  if (playerActiveKryptomon) {
    playerSprite.src = playerActiveKryptomon.image;
  }
  
  if (enemyActiveKryptomon) {
    enemySprite.src = enemyActiveKryptomon.image;
  }
}

function updateTurnInfo() {
  const turnInfo = document.getElementById('turn-info');
  const isYourTurn = gameState.currentTurn === yourIndex;
  
  turnInfo.innerHTML = `
    <div>${isYourTurn ? 'Your Turn' : "Opponent's Turn"}</div>
    <div class="turn-timer" id="turn-timer">30s</div>
  `;
  
  // Start turn timer
  startTurnTimer();
}

function updateControlButtons(playerData) {
  const isYourTurn = gameState.currentTurn === yourIndex;
  
  // Enable/disable buttons based on turn
  document.getElementById('attack-btn').disabled = !isYourTurn;
  document.getElementById('defend-btn').disabled = !isYourTurn || playerData.defenseCooldown > 0;
  document.getElementById('skill-btn').disabled = !isYourTurn || playerData.mana < 2;
  document.getElementById('ultimate-btn').disabled = !isYourTurn || playerData.mana < 6;
  
  // Update cooldown display
  if (playerData.defenseCooldown > 0) {
    document.getElementById('defend-btn').textContent = `üõ°Ô∏è Defend (${playerData.defenseCooldown})`;
  } else {
    document.getElementById('defend-btn').textContent = 'üõ°Ô∏è Defend';
  }
}

let turnTimer = null;

function startTurnTimer() {
  clearInterval(turnTimer);
  let timeLeft = 30;
  
  turnTimer = setInterval(() => {
    timeLeft--;
    const timerEl = document.getElementById('turn-timer');
    if (timerEl) {
      timerEl.textContent = `${timeLeft}s`;
      
      if (timeLeft <= 5) {
        timerEl.style.color = '#e74c3c';
      } else {
        timerEl.style.color = '#FFD700';
      }
    }
    
    if (timeLeft <= 0) {
      clearInterval(turnTimer);
      if (gameState && gameState.currentTurn === yourIndex) {
        socket.emit('turnTimeout');
      }
    }
  }, 1000);
}

function makeMove(move, activeKryptomon = undefined) {
  if (!socket || !gameState || gameState.currentTurn !== yourIndex) {
    console.log('‚ùå Cannot make move: not your turn or game not active');
    return;
  }
  
  console.log(`üéØ Making move: ${move}`, activeKryptomon);
  
  // Play sound effect
  if (move !== 'switch') {
    playSound(move);
  } else {
    playSound('switch');
  }
  
  socket.emit('playerMove', {
    move: move,
    activeKryptomon: activeKryptomon
  });
}

function handleMoveResult(moveResult) {
  console.log('üí• Handling move result:', moveResult);
  
  // Show damage numbers
  if (moveResult.damage > 0) {
    showDamageText(moveResult.targetIndex === yourIndex ? 'player' : 'enemy', moveResult.damage, moveResult.isCritical);
  }
  
  // Show battle animations
  if (moveResult.moveType && moveResult.moveType !== 'defend' && moveResult.moveType !== 'switch') {
    showBattleAnimation(moveResult.attackerIndex === yourIndex ? 'player' : 'enemy', moveResult.moveType);
  }
  
  // Show shield effect
  if (moveResult.shieldEffect) {
    const targetTrainer = moveResult.moveType === 'defend' ? 
      (moveResult.attackerIndex === yourIndex ? 'player' : 'enemy') :
      (moveResult.targetIndex === yourIndex ? 'player' : 'enemy');
    showShieldEffect(targetTrainer);
  }
  
  // Show ultimate effect
  if (moveResult.ultimateEffect) {
    showUltimateEffect(moveResult.attackerIndex === yourIndex ? 'player' : 'enemy');
  }
  
  // Handle Kryptomon switching
  if (moveResult.kryptomonSwitched || moveResult.autoSwitched) {
    const trainerSide = moveResult.attackerIndex === yourIndex ? 'player' : 'enemy';
    showKryptomonSwitchAnimation(trainerSide);
  }
  
  // Handle Kryptomon death
  if (moveResult.kryptomonDied) {
    console.log('üíÄ Kryptomon died!');
  }
}

function showDamageText(target, damage, isCritical = false) {
  const targetElement = document.getElementById(`${target}-trainer`);
  const rect = targetElement.getBoundingClientRect();
  
  const damageEl = document.createElement('div');
  damageEl.className = `damage-text ${isCritical ? 'critical' : ''}`;
  damageEl.textContent = isCritical ? `CRITICAL! ${damage}` : `-${damage}`;
  damageEl.style.left = `${rect.left + rect.width / 2}px`;
  damageEl.style.top = `${rect.top + rect.height / 2}px`;
  
  document.body.appendChild(damageEl);
  
  setTimeout(() => {
    if (damageEl.parentNode) {
      damageEl.parentNode.removeChild(damageEl);
    }
  }, 1500);
}

function showBattleAnimation(attacker, moveType) {
  const attackerSprite = document.getElementById(`${attacker}-kryptomon`);
  attackerSprite.classList.add(`${moveType}-animation`);
  
  setTimeout(() => {
    attackerSprite.classList.remove(`${moveType}-animation`);
  }, moveType === 'ultimate' ? 1200 : (moveType === 'skill' ? 800 : 600));
}

function showShieldEffect(target) {
  const targetElement = document.getElementById(`${target}-trainer`);
  
  const shieldEl = document.createElement('div');
  shieldEl.className = 'shield-effect';
  targetElement.appendChild(shieldEl);
  
  setTimeout(() => {
    if (shieldEl.parentNode) {
      shieldEl.parentNode.removeChild(shieldEl);
    }
  }, 800);
}

function showUltimateEffect(attacker) {
  const attackerElement = document.getElementById(`${attacker}-trainer`);
  
  const ultimateEl = document.createElement('div');
  ultimateEl.className = 'ultimate-effect';
  attackerElement.appendChild(ultimateEl);
  
  setTimeout(() => {
    if (ultimateEl.parentNode) {
      ultimateEl.parentNode.removeChild(ultimateEl);
    }
  }, 1500);
}

function showKryptomonSwitchAnimation(target) {
  const targetSprite = document.getElementById(`${target}-kryptomon`);
  
  // Out animation
  targetSprite.classList.add('kryptomon-switch-animation');
  
  setTimeout(() => {
    targetSprite.classList.remove('kryptomon-switch-animation');
    targetSprite.classList.add('kryptomon-switch-animation', 'slide-in');
    
    setTimeout(() => {
      targetSprite.classList.remove('kryptomon-switch-animation', 'slide-in');
    }, 1000);
  }, 1000);
}

function showEmojiAnimation(emoji) {
  const emojiEl = document.createElement('div');
  emojiEl.className = 'emoji-animation';
  emojiEl.textContent = emoji;
  
  document.body.appendChild(emojiEl);
  
  setTimeout(() => {
    if (emojiEl.parentNode) {
      emojiEl.parentNode.removeChild(emojiEl);
    }
  }, 2000);
}

function endGame(data) {
  console.log('üèÜ Game ended:', data);
  
  clearInterval(turnTimer);
  
  // Play victory or defeat sound
  if (data.winner === yourIndex) {
    playSound('victory');
  }
  
  // Show game end modal
  const isWin = data.winner === yourIndex;
  const resultText = isWin ? 'üéâ Victory!' : 'üò¢ Defeat!';
  const winnerText = data.winnerName || 'Unknown';
  
  setTimeout(() => {
    alert(`${resultText}\nWinner: ${winnerText}`);
    
    // Return to main menu
    gameContainer.style.display = 'none';
    showPlayerNameInput();
    
    // Reset game state
    gameState = null;
    yourIndex = -1;
    selectedKryptomon = [];
  }, 1000);
}

// Screen rotation handling
function checkOrientation() {
  const rotationPrompt = document.getElementById('rotation-prompt');
  if (window.innerHeight > window.innerWidth && window.innerWidth < 768) {
    rotationPrompt.style.display = 'flex';
  } else {
    rotationPrompt.style.display = 'none';
  }
}

window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);

// Initialize the game when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('üì± DOM loaded, initializing game...');
  checkOrientation();
  initGame();
});

// Handle page visibility for connection management
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    console.log('üì± Page hidden');
  } else {
    console.log('üì± Page visible');
    if (socket && !socket.connected) {
      console.log('üîÑ Reconnecting...');
      socket.connect();
    }
  }
});
</script>
</body>
</html>
