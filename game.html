<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFT PvP Turn-Based Game + Chat</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
  }
  
  #container {
    display: flex;
    width: 1200px;
    max-width: 95vw;
    height: 90vh;
    background: rgba(30, 30, 30, 0.95);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
  }
  
  #game {
    flex: 2.5;
    padding: 30px;
    position: relative;
    background: rgba(40, 40, 40, 0.8);
  }
  
  /* MetaMask Connection Styles */
  #metamask-container, #nft-selection-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(10px);
  }
  
  #metamask-modal, #nft-selection-modal {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  #connect-wallet-btn {
    background: linear-gradient(45deg, #f6851b, #ff6b35);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(246, 133, 27, 0.3);
  }
  
  #connect-wallet-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(246, 133, 27, 0.4);
  }
  
  #connect-wallet-btn:disabled {
    background: #666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  /* NFT Selection Styles */
  #nft-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-top: 25px;
    padding: 20px 0;
  }
  
  .nft-card {
    background: rgba(60, 60, 60, 0.9);
    border-radius: 15px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  
  .nft-card:hover {
    transform: translateY(-5px);
    border-color: #3498db;
    box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
  }
  
  .nft-card.selected {
    border-color: #2ecc71;
    background: rgba(46, 204, 113, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(46, 204, 113, 0.4);
  }
  
  .nft-image {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: 2px solid rgba(255,255,255,0.1);
  }
  
  .nft-info {
    font-size: 12px;
  }
  
  .nft-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    gap: 5px;
  }
  
  .stat {
    background: rgba(255,255,255,0.1);
    padding: 3px 6px;
    border-radius: 5px;
    font-size: 9px;
    font-weight: bold;
    flex: 1;
    text-align: center;
  }
  
  .health-stat { background: rgba(231, 76, 60, 0.8); }
  .attack-stat { background: rgba(243, 156, 18, 0.8); }
  .defense-stat { background: rgba(52, 152, 219, 0.8); }
  .speed-stat { background: rgba(155, 89, 182, 0.8); }
  
  #select-nft-btn, #refresh-nfts-btn {
    background: linear-gradient(45deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
  }
  
  #refresh-nfts-btn {
    background: linear-gradient(45deg, #f39c12, #e67e22);
    box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
  }
  
  #select-nft-btn:hover, #refresh-nfts-btn:hover {
    transform: translateY(-2px);
  }
  
  #select-nft-btn:disabled {
    background: #666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 30px 0;
    font-size: 16px;
  }
  
  .spinner {
    border: 3px solid rgba(255,255,255,0.3);
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-right: 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .wallet-status {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(30, 30, 30, 0.9);
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 12px;
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.3);
  }
  
  /* Game Area Styles */
  .player-area {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    gap: 20px;
  }
  
  .player {
    flex: 1;
    background: rgba(60, 60, 60, 0.8);
    border-radius: 15px;
    padding: 20px;
    position: relative;
    border: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  
  .player-nft-info {
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 14px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    word-break: break-all;
    min-height: 20px;
  }
  
  .your-nft-info {
    color: #3498db;
  }
  
  .enemy-nft-info {
    color: #e74c3c;
  }
  
  .player-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 15px;
    gap: 8px;
  }
  
  .player-stats .stat {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  .player img.character {
    width: 120px;
    height: 120px;
    border-radius: 15px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    margin-bottom: 15px;
    object-fit: cover;
    border: 3px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  
  .bar {
    background: rgba(40, 40, 40, 0.8);
    border-radius: 10px;
    height: 25px;
    margin-bottom: 12px;
    position: relative;
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
  }
  
  .bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1));
  }
  
  .health-fill {
    background: linear-gradient(90deg, #e74c3c, #c0392b);
  }
  
  .mana-fill {
    background: linear-gradient(90deg, #3498db, #2980b9);
  }
  
  .bar-label {
    position: absolute;
    width: 100%;
    text-align: center;
    font-weight: bold;
    top: 50%;
    transform: translateY(-50%);
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    font-size: 12px;
  }
  
  /* Action Buttons */
  #actions {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
    margin: 30px 0;
  }
  
  button.action-btn {
    background: linear-gradient(145deg, #555, #333);
    border: none;
    border-radius: 15px;
    width: 90px;
    height: 90px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border: 2px solid rgba(255,255,255,0.1);
  }
  
  button.action-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    border-color: rgba(255,255,255,0.3);
  }
  
  button.action-btn:disabled {
    background: linear-gradient(145deg, #333, #222);
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  button.action-btn img {
    width: 35px;
    height: 35px;
    margin-bottom: 5px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  }
  
  #status {
    margin-top: 25px;
    font-size: 20px;
    font-weight: bold;
    height: 30px;
    color: #ecf0f1;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  
  #victory-message {
    font-size: 42px;
    font-weight: bold;
    color: #2ecc71;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    padding: 30px 50px;
    border-radius: 20px;
    display: none;
    z-index: 10;
    border: 2px solid rgba(46, 204, 113, 0.5);
    box-shadow: 0 20px 40px rgba(0,0,0,0.8);
  }
  
  #back-to-menu-btn, #play-again-btn {
    display: none;
    margin-top: 15px;
    padding: 12px 25px;
    font-size: 16px;
    cursor: pointer;
    background: linear-gradient(45deg, #3498db, #2980b9);
    border: none;
    color: white;
    border-radius: 8px;
    position: absolute;
    z-index: 11;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
  }
  
  #back-to-menu-btn {
    top: 60%;
    left: 35%;
    transform: translate(-50%, -50%);
  }
  
  #play-again-btn {
    top: 60%;
    left: 65%;
    transform: translate(-50%, -50%);
  }
  
  #back-to-menu-btn:hover, #play-again-btn:hover {
    transform: translate(-50%, -50%) translateY(-2px);
  }

  /* Chat Styles */
  #chat-container {
    flex: 1;
    background: rgba(30, 30, 30, 0.9);
    display: flex;
    flex-direction: column;
    border-left: 2px solid rgba(255,255,255,0.1);
  }
  
  #chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.4;
    color: #ecf0f1;
  }
  
  #chat-input-area {
    display: flex;
    padding: 20px;
    background: rgba(20, 20, 20, 0.9);
    position: relative;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  #chat-input {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    background: rgba(60, 60, 60, 0.8);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  #chat-input::placeholder {
    color: rgba(255,255,255,0.5);
  }
  
  #chat-send-btn {
    background: linear-gradient(45deg, #3498db, #2980b9);
    border: none;
    color: white;
    font-weight: bold;
    padding: 12px 20px;
    margin-left: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  #chat-send-btn:hover:not(:disabled) {
    transform: translateY(-2px);
  }
  
  #chat-send-btn:disabled {
    background: #555;
    cursor: not-allowed;
    transform: none;
  }
  
  .chat-message {
    margin-bottom: 10px;
    word-break: break-word;
    padding: 8px 12px;
    border-radius: 8px;
    background: rgba(60, 60, 60, 0.3);
  }
  
  .chat-message.you {
    color: #76c7f0;
    background: rgba(118, 199, 240, 0.1);
  }
  
  .chat-message.enemy {
    color: #e67e22;
    background: rgba(230, 126, 34, 0.1);
  }
  
  .chat-message.system {
    color: #95a5a6;
    font-style: italic;
    background: rgba(149, 165, 166, 0.1);
  }
  
  #char-count {
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    position: absolute;
    right: 80px;
    bottom: 25px;
  }
  
  /* Animations */
  @keyframes damageEffect {
    0% { transform: scale(1); opacity: 1; }
    25% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
  }
  
  @keyframes healEffect {
    0% { transform: scale(1); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
  }
  
  @keyframes hydraEffect {
    0% { filter: drop-shadow(0 0 5px rgba(0, 255, 0, 0)); }
    50% { filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.8)); }
    100% { filter: drop-shadow(0 0 5px rgba(0, 255, 0, 0)); }
  }
  
  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }
  
  .damage-number, .heal-number, .mana-number {
    position: absolute;
    font-weight: bold;
    font-size: 24px;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }
  
  .damage-number {
    animation: damageEffect 0.8s ease-out forwards;
    color: #ff4d4d;
  }
  
  .heal-number {
    animation: healEffect 0.8s ease-out forwards;
    color: #4dff4d;
  }
  
  .mana-number {
    animation: healEffect 0.8s ease-out forwards;
    color: #4d4dff;
  }
  
  .shake-animation {
    animation: shake 0.5s ease-in-out;
  }
  
  .hydra-active {
    animation: hydraEffect 2s infinite;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    #container {
      flex-direction: column;
      height: auto;
      min-height: 90vh;
    }
    
    #game {
      flex: none;
    }
    
    #chat-container {
      flex: none;
      height: 300px;
      border-left: none;
      border-top: 2px solid rgba(255,255,255,0.1);
    }
    
    .player-area {
      flex-direction: column;
      gap: 15px;
    }
    
    #actions {
      gap: 15px;
    }
    
    button.action-btn {
      width: 70px;
      height: 70px;
    }
  }
</style>
</head>
<body>

<!-- MetaMask Connection Modal -->
<div id="metamask-container">
  <div id="metamask-modal">
    <h2>🦊 Connect Your Wallet</h2>
    <p>You need to connect your MetaMask wallet to play this NFT game.</p>
    <div id="metamask-status">
      <p id="connection-status">Please install MetaMask or connect your wallet.</p>
    </div>
    <button id="connect-wallet-btn">Connect MetaMask</button>
  </div>
</div>

<!-- NFT Selection Modal -->
<div id="nft-selection-container" style="display: none;">
  <div id="nft-selection-modal">
    <h2>⚔️ Select Your NFT Character</h2>
    <p>Choose an NFT from your collection to use as your warrior:</p>
    <div id="nft-loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <span>Loading your NFTs...</span>
    </div>
    <div id="nft-error" style="display: none; color: #e74c3c; margin: 20px 0; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;"></div>
    <div id="nft-grid"></div>
    <div style="margin-top: 25px;">
      <button id="select-nft-btn" disabled>⚡ Enter Battle</button>
      <button id="refresh-nfts-btn">🔄 Refresh NFTs</button>
    </div>
  </div>
</div>

<!-- Wallet Status Display -->
<div class="wallet-status" id="wallet-status" style="display: none;">
  🔗 <span id="connected-address"></span>
</div>

<div id="container" style="display: none;">
  <div id="game">
    <div class="player-area">
      <div class="player" id="you">
        <div class="player-nft-info your-nft-info" id="your-nft-info">Your NFT</div>
        <div class="player-stats" id="your-stats">
          <span class="stat health-stat">❤️ <span id="your-base-health">100</span></span>
          <span class="stat attack-stat">⚔️ <span id="your-attack">10</span></span>
          <span class="stat defense-stat">🛡️ <span id="your-defense">5</span></span>
        </div>
        <img src="" alt="Your NFT" class="character" id="player-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="you-health" style="width: 100%;"></div>
          <div class="bar-label" id="you-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="you-mana" style="width: 100%;"></div>
          <div class="bar-label" id="you-mana-label">Mana: 0</div>
        </div>
      </div>

      <div class="player" id="enemy">
        <div class="player-nft-info enemy-nft-info" id="enemy-nft-info">Enemy NFT</div>
        <div class="player-stats" id="enemy-stats">
          <span class="stat health-stat">❤️ <span id="enemy-base-health">100</span></span>
          <span class="stat attack-stat">⚔️ <span id="enemy-attack">10</span></span>
          <span class="stat defense-stat">🛡️ <span id="enemy-defense">5</span></span>
        </div>
        <img src="" alt="Enemy NFT" class="character" id="enemy-avatar" />
        <div class="bar" title="Health">
          <div class="bar-fill health-fill" id="enemy-health" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-health-label">Health: 0</div>
        </div>
        <div class="bar" title="Mana">
          <div class="bar-fill mana-fill" id="enemy-mana" style="width: 100%;"></div>
          <div class="bar-label" id="enemy-mana-label">Mana: 0</div>
        </div>
      </div>
    </div>

    <div id="actions">
      <button class="action-btn" id="attack-btn" title="Attack - Cost: 10 Mana">
        <div>⚔️</div>
        <div style="font-size: 11px;">Attack</div>
      </button>
      <button class="action-btn" id="defend-btn" title="Defend - Cost: 5 Mana">
        <div>🛡️</div>
        <div style="font-size: 11px;">Defend</div>
      </button>
      <button class="action-btn" id="skill-btn" title="Special Skill - Cost: 20 Mana">
        <div>✨</div>
        <div style="font-size: 11px;">Skill</div>
      </button>
      <button class="action-btn" id="mana-btn" title="Restore Mana">
        <div>💫</div>
        <div style="font-size: 11px;">Mana</div>
      </button>
      <button class="action-btn" id="hydra-btn" title="Ultimate Attack - Cost: 30 Mana">
        <div>🐲</div>
        <div style="font-size: 11px;">Ultimate</div>
      </button>
    </div>

    <div id="status">Ready to battle!</div>

    <div id="victory-message">🎉 Victory!</div>
    <button id="back-to-menu-btn">🏠 Back To Menu</button>
    <button id="play-again-btn">🔄 Play Again</button>
  </div>

  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Type message... (max 20 chars)" autocomplete="off" maxlength="20" />
      <span id="char-count">0/20</span>
      <button id="chat-send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<!-- Socket.io ve Ethers.js yükle -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
  // Global değişkenler
  let currentAccount = null;
  let provider = null;
  let signer = null;
  let selectedNFT = null;
  let userNFTs = [];
  let socket = null;
  let yourIndex = null;
  let yourData = null;
  let enemyData = null;
  let yourTurn = false;
  let gameActive = false;
  let yourNFTStats = null;
  let enemyNFTStats = null;

  // NFT Contract Address
  const NFT_CONTRACT_ADDRESS = "0xdfdb045e4300d04ec32058756ec2453409360c5b";
  
  // Basit ERC721 ABI
  const ERC721_ABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
    "function tokenURI(uint256 tokenId) view returns (string)"
  ];

  // DOM elemanları
  const metamaskContainer = document.getElementById('metamask-container');
  const nftSelectionContainer = document.getElementById('nft-selection-container');
  const connectWalletBtn = document.getElementById('connect-wallet-btn');
  const connectionStatus = document.getElementById('connection-status');
  const walletStatus = document.getElementById('wallet-status');
  const connectedAddress = document.getElementById('connected-address');
  const gameContainer = document.getElementById('container');
  const nftGrid = document.getElementById('nft-grid');
  const selectNFTBtn = document.getElementById('select-nft-btn');
  const refreshNFTsBtn = document.getElementById('refresh-nfts-btn');
  const nftLoading = document.getElementById('nft-loading');
  const nftError = document.getElementById('nft-error');

  // NFT özelliklerinden oyun statları hesaplama
  function calculateNFTStats(nft) {
    let health = 150;
    let attack = 15;
    let defense = 5;
    let speed = 10;

    const tokenIdNum = parseInt(nft.tokenId) || 0;
    
    // Token ID bazlı deterministic stat hesaplama
    const healthMod = (tokenIdNum * 7) % 50;
    const attackMod = (tokenIdNum * 11) % 25;
    const defenseMod = (tokenIdNum * 13) % 15;
    const speedMod = (tokenIdNum * 17) % 20;
    
    health += healthMod;
    attack += Math.floor(attackMod / 2);
    defense += Math.floor(defenseMod / 3);
    speed += Math.floor(speedMod / 2);

    // Rarity bonusu
    const rarityValue = tokenIdNum % 100;
    
    if (rarityValue >= 95) {
      health += 50; attack += 12; defense += 8;
      nft.rarity = "Legendary";
    } else if (rarityValue >= 80) {
      health += 30; attack += 8; defense += 5;
      nft.rarity = "Epic";
    } else if (rarityValue >= 50) {
      health += 20; attack += 5; defense += 3;
      nft.rarity = "Rare";
    } else {
      nft.rarity = "Common";
    }

    return {
      health: Math.min(health, 300),
      attack: Math.min(attack, 50),
      defense: Math.min(defense, 25),
      speed: Math.min(speed, 35)
    };
  }

  // MetaMask kontrolü
  async function checkMetaMask() {
    try {
      if (typeof ethers === 'undefined') {
        connectionStatus.textContent = 'Loading Web3 libraries...';
        setTimeout(checkMetaMask, 1000);
        return;
      }

      if (typeof window.ethereum !== 'undefined') {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        connectWalletBtn.textContent = 'Connect MetaMask';
        connectWalletBtn.disabled = false;
        
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            currentAccount = accounts[0];
            signer = provider.getSigner();
            showNFTSelection();
          } else {
            connectionStatus.textContent = 'Please connect your MetaMask wallet.';
          }
        } catch (error) {
          connectionStatus.textContent = 'Please connect your MetaMask wallet.';
        }
      } else {
        connectionStatus.textContent = 'MetaMask is not installed. Please install MetaMask to continue.';
        connectWalletBtn.textContent = 'Install MetaMask';
        connectWalletBtn.onclick = () => window.open('https://metamask.io/', '_blank');
      }
    } catch (error) {
      console.error('MetaMask check error:', error);
      connectionStatus.textContent = 'Error checking MetaMask. Please refresh the page.';
    }
  }

  // MetaMask'a bağlanma fonksiyonu
  async function connectWallet() {
    try {
      if (typeof ethers === 'undefined') {
        connectionStatus.textContent = 'Web3 libraries not loaded. Please refresh the page.';
        return;
      }

      connectWalletBtn.disabled = true;
      connectWalletBtn.textContent = 'Connecting...';
      
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts',
      });
      
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        showNFTSelection();
      } else {
        throw new Error('No accounts returned');
      }
    } catch (error) {
      console.error('Wallet connection failed:', error);
      connectionStatus.textContent = 'Connection failed. Please try again.';
      connectWalletBtn.disabled = false;
      connectWalletBtn.textContent = 'Connect MetaMask';
    }
  }

  // NFT seçim ekranını göster
  async function showNFTSelection() {
    try {
      metamaskContainer.style.display = 'none';
      nftSelectionContainer.style.display = 'flex';
      
      const shortAddress = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
      connectedAddress.textContent = shortAddress;
      walletStatus.style.display = 'block';
      
      await loadUserNFTs();
    } catch (error) {
      console.error('Error showing NFT selection:', error);
      nftError.textContent = 'Error loading NFT selection. Creating demo NFTs...';
      nftError.style.display = 'block';
      createDemoNFTs();
    }
  }

  // Kullanıcının NFT'lerini yükle (optimize edilmiş)
  async function loadUserNFTs() {
    try {
      nftLoading.style.display = 'flex';
      nftError.style.display = 'none';
      nftGrid.innerHTML = '';
      userNFTs = [];
      
      if (!provider) {
        throw new Error('Provider not initialized');
      }

      // NFT kontratına bağlan
      const nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, ERC721_ABI, provider);
      
      // Kullanıcının sahip olduğu NFT sayısını al (timeout ile)
      const balancePromise = nftContract.balanceOf(currentAccount);
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 10000)
      );
      
      const balance = await Promise.race([balancePromise, timeoutPromise]);
      console.log('NFT Balance:', balance.toString());
      
      if (balance.eq(0)) {
        throw new Error('You don\'t own any NFTs from this collection');
      }
      
      // Maksimum 8 NFT yükle (performans için)
      const maxLoad = Math.min(balance.toNumber(), 8);
      const loadPromises = [];
      
      for (let i = 0; i < maxLoad; i++) {
        const promise = loadSingleNFT(nftContract, i).catch(error => {
          console.error(`Error loading NFT ${i}:`, error);
          return null;
        });
        loadPromises.push(promise);
      }
      
      // Tüm NFT'leri paralel olarak yükle, 15 saniye timeout
      const timeoutAllPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Loading timeout')), 15000)
      );
      
      const results = await Promise.race([
        Promise.allSettled(loadPromises),
        timeoutAllPromise
      ]);
      
      // Başarılı yüklenen NFT'leri filtrele
      if (Array.isArray(results)) {
        userNFTs = results
          .filter(result => result.status === 'fulfilled' && result.value !== null)
          .map(result => result.value);
      }
      
      if (userNFTs.length === 0) {
        throw new Error('Could not load any NFTs');
      }
      
      console.log('Loaded NFTs:', userNFTs.length);
      displayNFTs();
      
    } catch (error) {
      console.error('Error loading NFTs:', error);
      nftError.innerHTML = `
        <strong>⚠️ NFT Loading Error</strong><br>
        ${error.message}<br>
        <small>Using demo NFTs for testing...</small>
      `;
      nftError.style.display = 'block';
      
      setTimeout(() => {
        createDemoNFTs();
      }, 2000);
      
    } finally {
      nftLoading.style.display = 'none';
    }
  }

  // Tek NFT yükleme fonksiyonu
  async function loadSingleNFT(contract, index) {
    const tokenId = await contract.tokenOfOwnerByIndex(currentAccount, index);
    
    const nft = {
      tokenId: tokenId.toString(),
      name: `NFT #${tokenId.toString()}`,
      description: `Warrior from the collection`,
      image: `https://picsum.photos/200/200?random=${tokenId.toString()}`,
      traits: []
    };
    
    // Token URI'yi almaya çalış (opsiyonel, hızlı timeout ile)
    try {
      const uriPromise = contract.tokenURI(tokenId);
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('URI timeout')), 3000)
      );
      
      const tokenURI = await Promise.race([uriPromise, timeoutPromise]);
      
      if (tokenURI && (tokenURI.startsWith('http') || tokenURI.startsWith('ipfs'))) {
        let metadataURL = tokenURI;
        if (tokenURI.startsWith('ipfs://')) {
          metadataURL = tokenURI.replace('ipfs://', 'https://ipfs.io/ipfs/');
        }
        
        const response = await fetch(metadataURL, { 
          signal: AbortSignal.timeout(5000) 
        });
        const metadata = await response.json();
        
        nft.name = metadata.name || nft.name;
        nft.description = metadata.description || nft.description;
        
        if (metadata.image) {
          let imageURL = metadata.image;
          if (imageURL.startsWith('ipfs://')) {
            imageURL = imageURL.replace('ipfs://', 'https://ipfs.io/ipfs/');
          }
          nft.image = imageURL;
        }
        
        nft.traits = metadata.attributes || [];
      }
    } catch (uriError) {
      console.log(`URI error for token ${tokenId}:`, uriError.message);
    }
    
    return nft;
  }

  // Demo NFT'ler oluştur
  function createDemoNFTs() {
    userNFTs = [];
    
    const demoNames = [
      "Fire Warrior", "Ice Mage", "Shadow Assassin", 
      "Holy Paladin", "Earth Guardian", "Wind Archer"
    ];
    
    for (let i = 1; i <= 6; i++) {
      const nft = {
        tokenId: i.toString(),
        name: demoNames[i-1] || `Demo Warrior #${i}`,
        image: `https://picsum.photos/200/200?random=${i + 1000}`,
        traits: [
          { trait_type: "Strength", value: (20 + Math.random() * 80).toFixed(0) },
          { trait_type: "Speed", value: (20 + Math.random() * 80).toFixed(0) },
          { trait_type: "Magic", value: (20 + Math.random() * 80).toFixed(0) }
        ]
      };
      userNFTs.push(nft);
    }
    
    console.log('Created demo NFTs:', userNFTs.length);
    displayNFTs();
    nftError.style.display = 'none';
  }

  // NFT'leri ekranda göster
  function displayNFTs() {
    nftGrid.innerHTML = '';
    
    userNFTs.forEach((nft, index) => {
      const stats = calculateNFTStats(nft);
      
      const nftCard = document.createElement('div');
      nftCard.className = 'nft-card';
      nftCard.dataset.index = index;
      
      nftCard.innerHTML = `
        <img src="${nft.image}" alt="${nft.name}" class="nft-image" 
             onerror="this.src='https://via.placeholder.com/200x200/667eea/ffffff?text=NFT+${nft.tokenId}'" 
             loading="lazy" />
        <div class="nft-info">
          <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">${nft.name}</div>
          <div style="font-size: 10px; color: #bbb; margin-bottom: 8px;">
            ${nft.rarity || 'Common'} • #${nft.tokenId}
          </div>
          <div class="nft-stats">
            <span class="stat health-stat">❤️ ${stats.health}</span>
            <span class="stat attack-stat">⚔️ ${stats.attack}</span>
          </div>
          <div class="nft-stats">
            <span class="stat defense-stat">🛡️ ${stats.defense}</span>
            <span class="stat speed-stat">⚡ ${stats.speed}</span>
          </div>
        </div>
      `;
      
      nftCard.addEventListener('click', () => selectNFTCard(index));
      nftGrid.appendChild(nftCard);
    });
  }

  // NFT kartı seçimi
  function selectNFTCard(index) {
    document.querySelectorAll('.nft-card').forEach(card => {
      card.classList.remove('selected');
    });
    
    const selectedCard = document.querySelector(`[data-index="${index}"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
      selectedNFT = userNFTs[index];
      selectNFTBtn.disabled = false;
      
      // Seçilen NFT'nin istatistiklerini göster
      const stats = calculateNFTStats(selectedNFT);
      console.log('Selected NFT stats:', stats);
    }
  }

  // NFT seçimini onayla ve oyuna başla
  function confirmNFTSelection() {
    if (selectedNFT) {
      nftSelectionContainer.style.display = 'none';
      gameContainer.style.display = 'flex';
      initializeGame();
    }
  }

  // NFT'leri yenile
  async function refreshNFTs() {
    selectedNFT = null;
    selectNFTBtn.disabled = true;
    await loadUserNFTs();
  }

  // Hesap değişikliği dinleyicisi
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        currentAccount = null;
        selectedNFT = null;
        provider = null;
        signer = null;
        walletStatus.style.display = 'none';
        gameContainer.style.display = 'none';
        nftSelectionContainer.style.display = 'none';
        metamaskContainer.style.display = 'flex';
        if (socket) {
          socket.disconnect();
        }
      } else if (accounts[0] !== currentAccount) {
        currentAccount = accounts[0];
        selectedNFT = null;
        if (provider) {
          signer = provider.getSigner();
          showNFTSelection();
        }
      }
    });
  }

  // Event listeners
  window.addEventListener('load', () => {
    setTimeout(checkMetaMask, 1000);
  });
  
  connectWalletBtn.addEventListener('click', connectWallet);
  selectNFTBtn.addEventListener('click', confirmNFTSelection);
  refreshNFTsBtn.addEventListener('click', refreshNFTs);

  // Oyun başlatma fonksiyonu
  function initializeGame() {
    console.log('🎮 Starting game with NFT:', selectedNFT.name);
    
    // Socket bağlantısı
    socket = io();

    // Seçilen NFT'nin statlarını hesapla
    yourNFTStats = calculateNFTStats(selectedNFT);
    
    // NFT bilgilerini göster
    document.getElementById('your-nft-info').textContent = selectedNFT.name;
    document.getElementById('your-base-health').textContent = yourNFTStats.health;
    document.getElementById('your-attack').textContent = yourNFTStats.attack;
    document.getElementById('your-defense').textContent = yourNFTStats.defense;
    
    // NFT avatarını ayarla
    const playerAvatar = document.getElementById('player-avatar');
    playerAvatar.src = selectedNFT.image;
    playerAvatar.onerror = function() {
      this.src = `https://via.placeholder.com/120x120/667eea/ffffff?text=${selectedNFT.name.slice(0,2)}`;
    };

    // UI elemanları
    const youHealthBar = document.getElementById('you-health');
    const youManaBar = document.getElementById('you-mana');
    const youHealthLabel = document.getElementById('you-health-label');
    const youManaLabel = document.getElementById('you-mana-label');

    const enemyHealthBar = document.getElementById('enemy-health');
    const enemyManaBar = document.getElementById('enemy-mana');
    const enemyHealthLabel = document.getElementById('enemy-health-label');
    const enemyManaLabel = document.getElementById('enemy-mana-label');
    const enemyAvatar = document.getElementById('enemy-avatar');

    const statusDiv = document.getElementById('status');
    const victoryMessage = document.getElementById('victory-message');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const playAgainBtn = document.getElementById('play-again-btn');

    const attackBtn = document.getElementById('attack-btn');
    const defendBtn = document.getElementById('defend-btn');
    const skillBtn = document.getElementById('skill-btn');
    const manaBtn = document.getElementById('mana-btn');
    const hydraBtn = document.getElementById('hydra-btn');

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const charCount = document.getElementById('char-count');

    // Bar güncelleme fonksiyonu
    function updateBars() {
      if (!yourData || !enemyData) return;

      const yourHealthPercent = (yourData.health / yourNFTStats.health) * 100;
      const enemyHealthPercent = (enemyData.health / (enemyNFTStats ? enemyNFTStats.health : 200)) * 100;
      
      youHealthBar.style.width = Math.max(0, yourHealthPercent) + '%';
      enemyHealthBar.style.width = Math.max(0, enemyHealthPercent) + '%';

      youManaBar.style.width = Math.max(0, (yourData.mana / 100) * 100) + '%';
      enemyManaBar.style.width = Math.max(0, (enemyData.mana / 100) * 100) + '%';

      youHealthLabel.textContent = `Health: ${Math.max(0, yourData.health)}`;
      enemyHealthLabel.textContent = `Health: ${Math.max(0, enemyData.health)}`;

      youManaLabel.textContent = `Mana: ${Math.max(0, yourData.mana)}`;
      enemyManaLabel.textContent = `Mana: ${Math.max(0, enemyData.mana)}`;
    }

    // Button durumu güncelleme
    function updateButtonStatus() {
      const disabled = !yourTurn || !gameActive;
      
      attackBtn.disabled = disabled || (yourData && yourData.mana < 10);
      defendBtn.disabled = disabled || (yourData && yourData.mana < 5);
      skillBtn.disabled = disabled || (yourData && yourData.mana < 20);
      hydraBtn.disabled = disabled || (yourData && yourData.mana < 30) || (yourData && yourData.hydraUsed);
      manaBtn.disabled = disabled;
    }

    // Chat mesaj fonksiyonu
    function addChatMessage(message, sender = 'system') {
      const messageElement = document.createElement('div');
      messageElement.className = `chat-message ${sender}`;
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Socket event handlers
    socket.on('connect', () => {
      console.log('🔗 Connected to server');
      addChatMessage('Connected to server', 'system');
      
      socket.emit('playerMove', { 
        move: 'join',
        walletAddress: currentAccount,
        selectedNFT: selectedNFT
      });
    });

    socket.on('waitingForOpponent', () => {
      statusDiv.textContent = '⏳ Waiting for opponent...';
      addChatMessage('Waiting for opponent...', 'system');
    });

    socket.on('gameStart', (data) => {
      console.log('🎮 Game started:', data);
      
      yourIndex = data.yourIndex;
      yourData = data.you;
      enemyData = data.enemy;
      gameActive = true;
      yourTurn = yourIndex === 0;
      
      // Enemy NFT bilgilerini göster
      if (data.enemyNFT) {
        enemyNFTStats = calculateNFTStats(data.enemyNFT);
        document.getElementById('enemy-nft-info').textContent = data.enemyNFT.name;
        document.getElementById('enemy-base-health').textContent = enemyNFTStats.health;
        document.getElementById('enemy-attack').textContent = enemyNFTStats.attack;
        document.getElementById('enemy-defense').textContent = enemyNFTStats.defense;
        
        enemyAvatar.src = data.enemyNFT.image;
        enemyAvatar.onerror = function() {
          this.src = `https://via.placeholder.com/120x120/e74c3c/ffffff?text=${data.enemyNFT.name.slice(0,2)}`;
        };
      }
      
      updateBars();
      updateButtonStatus();
      
      statusDiv.textContent = yourTurn ? '⚔️ Your turn!' : '⏳ Enemy\'s turn';
      addChatMessage(`🎮 Game started! You are ${yourIndex === 0 ? 'Player 1' : 'Player 2'}`, 'system');
    });

    socket.on('moveConfirmed', (data) => {
      yourData = data.you;
      enemyData = data.enemy;
      yourTurn = false;
      
      updateBars();
      updateButtonStatus();
      statusDiv.textContent = '⏳ Enemy\'s turn';
      
      addChatMessage(`✅ You used ${data.move}`, 'system');
    });

    socket.on('enemyMove', (data) => {
      yourData = data.you;
      enemyData = data.enemy;
      yourTurn = true;
      
      updateBars();
      updateButtonStatus();
      statusDiv.textContent = '⚔️ Your turn!';
      
      addChatMessage(`🎯 Enemy used ${data.move}`, 'system');
    });

    socket.on('gameOver', (data) => {
      gameActive = false;
      updateButtonStatus();
      
      if (data.winner === 'player') {
        victoryMessage.textContent = '🎉 Victory!';
        victoryMessage.style.color = '#2ecc71';
        statusDiv.textContent = '🎊 You won!';
      } else {
        victoryMessage.textContent = '💀 Defeat!';
        victoryMessage.style.color = '#e74c3c';
        statusDiv.textContent = '😞 You lost!';
      }
      
      victoryMessage.style.display = 'block';
      backToMenuBtn.style.display = 'block';
      playAgainBtn.style.display = 'block';
      
      addChatMessage(`🏁 Game Over - ${data.winner === 'player' ? 'You Win!' : 'You Lose!'}`, 'system');
    });

    socket.on('chatMessage', (data) => {
      const sender = data.fromIndex === yourIndex ? 'you' : 'enemy';
      addChatMessage(data.message, sender);
    });

    socket.on('errorMessage', (message) => {
      addChatMessage(`❌ Error: ${message}`, 'system');
    });

    // Button event listeners
    attackBtn.addEventListener('click', () => {
      if (yourTurn && gameActive && yourData && yourData.mana >= 10) {
        socket.emit('playerMove', { move: 'attack' });
      }
    });

    defendBtn.addEventListener('click', () => {
      if (yourTurn && gameActive && yourData && yourData.mana >= 5) {
        socket.emit('playerMove', { move: 'defend' });
      }
    });

    skillBtn.addEventListener('click', () => {
      if (yourTurn && gameActive && yourData && yourData.mana >= 20) {
        socket.emit('playerMove', { move: 'skill' });
      }
    });

    manaBtn.addEventListener('click', () => {
      if (yourTurn && gameActive) {
        socket.emit('playerMove', { move: 'mana' });
      }
    });

    hydraBtn.addEventListener('click', () => {
      if (yourTurn && gameActive && yourData && yourData.mana >= 30 && !yourData.hydraUsed) {
        socket.emit('playerMove', { move: 'hydra' });
      }
    });

    // Oyun sonu kontrolleri
    backToMenuBtn.addEventListener('click', () => {
      location.reload();
    });

    playAgainBtn.addEventListener('click', () => {
      victoryMessage.style.display = 'none';
      backToMenuBtn.style.display = 'none';
      playAgainBtn.style.display = 'none';
      
      socket.emit('playerMove', { 
        move: 'join',
        walletAddress: currentAccount,
        selectedNFT: selectedNFT
      });
    });

    // Chat kontrolleri
    chatInput.addEventListener('input', () => {
      const length = chatInput.value.length;
      charCount.textContent = `${length}/20`;
      chatSendBtn.disabled = length === 0;
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !chatSendBtn.disabled) {
        sendChatMessage();
      }
    });

    chatSendBtn.addEventListener('click', sendChatMessage);

    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (message && socket) {
        socket.emit('chatMessage', { message: message });
        addChatMessage(message, 'you');
        chatInput.value = '';
        charCount.textContent = '0/20';
        chatSendBtn.disabled = true;
      }
    }

    // İlk mesaj
    addChatMessage('🎮 Welcome to NFT Battle Arena!', 'system');
  }
</script>
</body>
</html>
